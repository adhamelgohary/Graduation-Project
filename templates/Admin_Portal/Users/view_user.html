{% extends "Admin_Portal/base.html" %}

{% block title %}View User{% endblock %}

{% block nav_users %}active{% endblock %}

{% block header_title %}<i class="fas fa-user"></i> User Details{% endblock %}

{% block extra_css %}
<style>
    .user-profile {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .profile-section {
        background-color: #f4f4f4;
        border-radius: 8px;
        padding: 20px;
    }
    .audit-log-table {
        width: 100%;
        border-collapse: collapse;
    }
    .audit-log-table th, .audit-log-table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }
    .documents-section {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="user-profile">
        <div class="profile-section">
            <h2>Basic Information</h2>
            <p><strong>Username:</strong> {{ user.username }}</p>
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Name:</strong> {{ user.first_name }} {{ user.last_name }}</p>
            <p><strong>User Type:</strong> {{ user.user_type|capitalize }}</p>
            <p><strong>Phone:</strong> {{ user.phone or 'N/A' }}</p>
            <p><strong>Country:</strong> {{ user.country or 'N/A' }}</p>
            <p><strong>Account Status:</strong> {{ user.account_status|capitalize }}</p>

            <!-- Additional Doctor Details -->
            {% if user.user_type == 'doctor' %}
            <h3>Doctor Information</h3>
            <p><strong>Specialization:</strong> {{ user.specialization or 'N/A' }}</p>
            <p><strong>License Number:</strong> {{ user.license_number or 'N/A' }}</p>
            <p><strong>Verification Status:</strong> {{ user.verification_status|capitalize }}</p>
            {% endif %}

            <!-- Additional Patient Details -->
            {% if user.user_type == 'patient' %}
            <h3>Patient Information</h3>
            <p><strong>Date of Birth:</strong> {{ user.date_of_birth or 'N/A' }}</p>
            <p><strong>Gender:</strong> {{ user.gender or 'N/A' }}</p>
            {% endif %}
        </div>

        <div class="profile-section">
            <div class="user-actions">
                <h2>User Actions</h2>
                <form method="POST" action="{{ url_for('admin_users.update_status', user_id=user.user_id) }}">
                    <select name="status" class="form-control">
                        <option value="active" {% if user.account_status == 'active' %}selected{% endif %}>Active</option>
                        <option value="inactive" {% if user.account_status == 'inactive' %}selected{% endif %}>Inactive</option>
                        <option value="suspended" {% if user.account_status == 'suspended' %}selected{% endif %}>Suspended</option>
                        <option value="pending" {% if user.account_status == 'pending' %}selected{% endif %}>Pending</option>
                    </select>
                    <button type="submit" class="btn btn-warning">Update Status</button>
                </form>

                <form method="POST" action="{{ url_for('admin_users.reset_password', user_id=user.user_id) }}">
                    <input type="password" name="new_password" placeholder="New Password" required>
                    <button type="submit" class="btn btn-danger">Reset Password</button>
                </form>
            </div>

            {% if user.user_type == 'doctor' %}
            <div class="doctor-verification">
                <h2>Doctor Verification</h2>
                <form method="POST" action="{{ url_for('admin_users.update_doctor_verification', user_id=user.user_id) }}">
                    <select name="verification_status" class="form-control">
                        <option value="pending" {% if user.verification_status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="approved" {% if user.verification_status == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="rejected" {% if user.verification_status == 'rejected' %}selected{% endif %}>Rejected</option>
                        <option value="pending_info" {% if user.verification_status == 'pending_info' %}selected{% endif %}>Pending Additional Info</option>
                    </select>
                    <textarea name="rejection_reason" placeholder="Rejection Reason (if rejected)"></textarea>
                    <button type="submit" class="btn btn-primary">Update Verification</button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>

    {% if user.user_type == 'doctor' %}
    <div class="documents-section profile-section">
        <h2>Uploaded Documents</h2>
        <form method="POST" action="{{ url_for('admin_users.upload_doctor_document', user_id=user.user_id) }}" enctype="multipart/form-data">
            <select name="document_type" required>
                <option value="">Select Document Type</option>
                <option value="license">License</option>
                <option value="certification">Certification</option>
                <option value="identity">Identity</option>
                <option value="education">Education</option>
                <option value="other">Other</option>
            </select>
            <input type="file" name="document" required>
            <button type="submit" class="btn btn-success">Upload Document</button>
        </form>

        <table>
            <thead>
                <tr>
                    <th>Document Type</th>
                    <th>File Name</th>
                    <th>Size</th>
                    <th>Upload Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in user.documents %}
                <tr>
                    <td>{{ doc.document_type|capitalize }}</td>
                    <td>{{ doc.file_name }}</td>
                    <td>{{ (doc.file_size/1024)|round(2) }} KB</td>
                    <td>{{ doc.upload_date }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('admin_users.delete_doctor_document', document_id=doc.document_id) }}">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="audit-log-section profile-section">
        <h2>Audit Logs</h2>
        <table class="audit-log-table">
            <thead>
                <tr>
                    <th>Action</th>
                    <th>Details</th>
                    <th>Performed By</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody>
                {% for log in audit_logs %}
                <tr>
                    <td>{{ log.action_type|replace('_', ' ')|title }}</td>
                    <td>{{ log.action_details }}</td>
                    <td>{{ log.performed_by_name }}</td>
                    <td>{{ log.performed_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}