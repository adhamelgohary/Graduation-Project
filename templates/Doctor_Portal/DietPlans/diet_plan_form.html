{% extends "Doctor_Portal/base.html" %}
{% block title %}{{ form_title }}{% endblock %}

{% block head_extra %}
    {# Add CSS for form structure, meal/item blocks if needed #}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" /> {# Example for multi-select #}
    <style>
        .meal-form-block, .item-form-block { border: 1px solid #ddd; padding: 1rem; margin-bottom: 1rem; border-radius: 5px; background: #f9f9f9;}
        .meal-form-block h5, .item-form-block h6 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem;}
        .remove-button { color: red; cursor: pointer; font-weight: bold; margin-left: 10px; }
    </style>
{% endblock %}

{% block content %}
 <div class="page-header">
    <h1>{{ form_title }}</h1>
    <a href="{{ url_for('.list_diet_plans') }}" class="button button-outline button-secondary"><i class="fas fa-arrow-left"></i> Cancel</a>
</div>

{# Display Errors/Flash messages here #}
 {% include '_flash_messages.html' %} {# Assuming a partial for flash messages #}

<form action="{{ form_action }}" method="POST" class="card shadow-sm content-section data-form">
    <div class="card-body">
        <h4>Plan Details</h4>
        {# Plan Fields: plan_name, plan_type, description, macros, is_public etc. #}
         <div class="row">
             <div class="col-md-6 form-group mb-3">
                <label for="plan_name" class="form-label">Plan Name <span class="text-danger">*</span></label>
                <input type="text" id="plan_name" name="plan_name" class="form-control" value="{{ plan.plan_name | default(request.form.get('plan_name', '')) }}" required>
             </div>
             <div class="col-md-6 form-group mb-3">
                <label for="plan_type" class="form-label">Plan Type <span class="text-danger">*</span></label>
                <select id="plan_type" name="plan_type" class="form-select" required>
                    <option value="" disabled {% if not (plan.plan_type or request.form.get('plan_type')) %}selected{% endif %}>-- Select --</option>
                     {% set selected_type = (plan.plan_type or request.form.get('plan_type')) | string %}
                     {% for ptype in plan_types %}
                     <option value="{{ ptype }}" {% if selected_type == ptype %}selected{% endif %}>{{ ptype | title }}</option>
                     {% endfor %}
                </select>
             </div>
         </div>
        {# ... Other plan fields (calories, protein, etc.) ... #}
         <div class="form-group mb-3">
            <label for="target_conditions" class="form-label">Target Conditions (Optional)</label>
            <select id="target_conditions" name="target_conditions" class="form-select select2-multiple" multiple="multiple">
                {# Pre-select based on plan.target_conditions_list #}
                {% set selected_conditions = plan.target_conditions_list if plan else request.form.getlist('target_conditions') %}
                {% for condition in conditions %}
                <option value="{{ condition.condition_name }}" {% if condition.condition_name in selected_conditions %}selected{% endif %}>{{ condition.condition_name }}</option>
                {% endfor %}
            </select>
         </div>
         <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" role="switch" id="is_public" name="is_public" {% if plan.is_public or request.form.get('is_public') == 'on' %}checked{% endif %}>
              <label class="form-check-label" for="is_public">Make Publicly Available</label>
         </div>

        <hr>
        <h4>Meals & Food Items</h4>
        <div id="meals-container">
            {# Loop through existing meals (if editing) #}
            {% if plan and meals %}
                {% for meal in meals %}
                <div class="meal-form-block" data-meal-id="{{ meal.meal_id }}">
                    <input type="hidden" name="meal_id" value="{{ meal.meal_id }}"> {# Track existing ID #}
                    <h5>
                        Edit Meal
                        <span class="remove-button" onclick="removeMeal(this, '{{ meal.meal_id }}')">× Remove Meal</span>
                    </h5>
                     <div class="row">
                         <div class="col-md-5 form-group mb-2">
                             <label>Meal Name</label>
                             <input type="text" name="meal_name[{{ meal.meal_id }}]" class="form-control form-control-sm" value="{{ meal.meal_name }}">
                         </div>
                         <div class="col-md-4 form-group mb-2">
                             <label>Meal Type</label>
                             <select name="meal_type[{{ meal.meal_id }}]" class="form-select form-select-sm">
                                 {% for mtype in meal_types %}<option value="{{ mtype }}" {% if meal.meal_type == mtype %}selected{% endif %}>{{ mtype | title }}</option>{% endfor %}
                             </select>
                         </div>
                         <div class="col-md-3 form-group mb-2">
                             <label>Time (HH:MM)</label>
                             {# --- UPDATED LINE --- #}
                             <input type="time" name="meal_time[{{ meal.meal_id }}]" class="form-control form-control-sm" value="{{ meal.time_of_day | timedelta_to_time('%H:%M') if meal.time_of_day else '' }}">
                             {# --- END UPDATED LINE --- #}
                         </div>
                     </div>
                     <div class="form-group mb-3">
                         <label>Meal Description</label>
                         <textarea name="meal_desc[{{ meal.meal_id }}]" class="form-control form-control-sm" rows="2">{{ meal.description | default('') }}</textarea>
                     </div>

                     {# ... rest of meal item form ... #}
                </div>
                {% endfor %}
            {% endif %}
        </div> {# End #meals-container #}

        <button type="button" id="add-meal-btn" class="button button-outline button-info button-small mt-3"><i class="fas fa-plus"></i> Add Another Meal</button>

         {# Hidden inputs to track deletions #}
         <div id="deleted-inputs">
             {# JS will add inputs like: <input type="hidden" name="deleted_meal_ids" value="ID_TO_DELETE"> #}
         </div>

        <div class="form-actions mt-4 pt-3 border-top">
            <a href="{{ url_for('.list_diet_plans') }}" class="button button-outline button-secondary">Cancel</a>
            <button type="submit" class="button button-primary">
                <i class="fas fa-save"></i> {{ 'Update Diet Plan' if plan else 'Save and Add Meals' }}
            </button>
        </div>
    </div> {# End card-body #}
</form>

{# Templates for dynamic forms (used by JS) #}
<template id="meal-form-template">
     <div class="meal-form-block" data-new-meal-index="{index}">
        <h5>
            New Meal
             <span class="remove-button" onclick="removeNewMeal(this)">× Remove Meal</span>
         </h5>
         <div class="row">
             <div class="col-md-5 form-group mb-2"><label>Meal Name</label><input type="text" name="new_meal_name" class="form-control form-control-sm"></div>
             <div class="col-md-4 form-group mb-2"><label>Meal Type</label><select name="new_meal_type" class="form-select form-select-sm">{% for mtype in meal_types %}<option value="{{ mtype }}">{{ mtype | title }}</option>{% endfor %}</select></div>
             <div class="col-md-3 form-group mb-2"><label>Time (HH:MM)</label><input type="time" name="new_meal_time" class="form-control form-control-sm"></div>
         </div>
         <div class="form-group mb-3"><label>Meal Description</label><textarea name="new_meal_desc" class="form-control form-control-sm" rows="2"></textarea></div>
         <h6>Food Items</h6>
         <div class="items-container-new_{index}"></div>
         <button type="button" class="button button-outline button-success button-xsmall mt-2" onclick="addItemForm('new_{index}')"><i class="fas fa-plus"></i> Add Food Item to this Meal</button>
    </div>
</template>
<template id="item-form-template">
     <div class="item-form-block" data-new-item="true">
        <div class="row">
            <div class="col-md-5"><input type="text" name="new_item_food_name[{meal_ref}]" placeholder="Food Name" class="form-control form-control-sm"></div>
            <div class="col-md-4"><input type="text" name="new_item_serving_size[{meal_ref}]" placeholder="Serving Size" class="form-control form-control-sm"></div>
            <div class="col-md-3"><span class="remove-button" onclick="removeNewItem(this)">× Remove Item</span></div>
        </div>
        <textarea name="new_item_notes[{meal_ref}]" placeholder="Notes" class="form-control form-control-sm mt-1" rows="1"></textarea>
        <textarea name="new_item_alternatives[{meal_ref}]" placeholder="Alternatives" class="form-control form-control-sm mt-1" rows="1"></textarea>
     </div>
</template>

{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> {# Select2 requires jQuery #}
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.select2-multiple').select2({
                placeholder: "Select conditions",
                allowClear: true,
                tags: true // Allow adding new conditions if needed? Maybe not.
            });
        });

        let newMealIndex = 0;

        function addMealForm() {
            const template = document.getElementById('meal-form-template');
            const container = document.getElementById('meals-container');
            let content = template.innerHTML.replace(/{index}/g, newMealIndex);
            container.insertAdjacentHTML('beforeend', content);
            newMealIndex++;
        }

        function addItemForm(mealRef) { // mealRef is existing meal ID or 'new_{index}'
            const template = document.getElementById('item-form-template');
             // Find the correct container within the specific meal block
            const container = document.querySelector(`.items-container-${mealRef}`);
             if (!container) { console.error("Item container not found for", mealRef); return; }
            let content = template.innerHTML.replace(/{meal_ref}/g, mealRef);
            container.insertAdjacentHTML('beforeend', content);
        }

         function removeMeal(element, mealId) {
             if (confirm('Remove this entire meal and its items?')) {
                const block = element.closest('.meal-form-block');
                block.remove();
                // Add hidden input to track deletion
                const hiddenInput = `<input type="hidden" name="deleted_meal_ids" value="${mealId}">`;
                document.getElementById('deleted-inputs').insertAdjacentHTML('beforeend', hiddenInput);
             }
         }
          function removeNewMeal(element) {
               if (confirm('Remove this new meal?')) {
                   element.closest('.meal-form-block').remove();
               }
         }

         function removeItem(element, itemId) {
               if (confirm('Remove this food item?')) {
                   const block = element.closest('.item-form-block');
                   block.remove();
                   const hiddenInput = `<input type="hidden" name="deleted_item_ids" value="${itemId}">`;
                   document.getElementById('deleted-inputs').insertAdjacentHTML('beforeend', hiddenInput);
               }
         }
         function removeNewItem(element) {
              if (confirm('Remove this new food item?')) {
                  element.closest('.item-form-block').remove();
              }
        }

        document.getElementById('add-meal-btn').addEventListener('click', addMealForm);

    </script>
{% endblock %}