{% extends "Doctor_Portal/base.html" %}
{% block title %}Diet Plans{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/disease_catalog.css') }}"> {# Assuming shared CSS #}
     <style>
        /* Styles for filter form */
        .filter-form .form-select-sm { height: calc(1.5em + 0.5rem + 2px); }
        .table th, .table td { vertical-align: middle; }
        /* Sorting icon styles */
        th a { color: inherit; text-decoration: none; }
        th a:hover { color: var(--color-primary); }
        th .sort-icon { opacity: 0.4; font-size: 0.8em; margin-left: 5px; }
        th .sort-icon.active { opacity: 1; color: var(--color-primary); }
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Diet Plan Management</h1>
    {# Conditionally show Add button based on dietitian role #}
    {% if can_manage_plans %}
        <a href="{{ url_for('diet_plans.add_diet_plan') }}" class="button button-primary"><i class="fas fa-plus"></i> Add New Plan</a>
    {% endif %}
</div>

{# Flash Messages #}
{% include '_flash_messages.html' %} {# Assuming a partial template #}

{# Search/Filter Form #}
<form method="GET" action="{{ url_for('diet_plans.list_diet_plans') }}" class="search-form card card-body mb-4">
    <div class="row g-3 align-items-end">
        {# Search Input #}
        <div class="col-lg-4 col-md-12">
            <label for="search" class="form-label visually-hidden">Search</label>
            <div class="input-group">
                 <span class="input-group-text"><i class="fas fa-search fa-fw"></i></span>
                <input type="search" class="form-control" id="search" name="search" placeholder="Search Name, Desc, Conditions..." value="{{ search_term | default('') }}">
            </div>
        </div>
         {# Type Filter #}
        <div class="col-lg col-md-4 col-sm-6">
            <label for="filter_type" class="form-label">Plan Type</label>
             <select id="filter_type" name="filter_type" class="form-select form-select-sm">
                 <option value="" {% if not filters.plan_type %}selected{% endif %}>Any Type</option>
                  {% for type_val in plan_types %}
                    <option value="{{ type_val }}" {% if filters.plan_type == type_val %}selected{% endif %}>{{ type_val | title }}</option>
                 {% endfor %}
            </select>
        </div>
         {# Public/Private Filter #}
        <div class="col-lg col-md-4 col-sm-6">
            <label for="filter_public" class="form-label">Availability</label>
             <select id="filter_public" name="filter_public" class="form-select form-select-sm">
                 <option value="" {% if filters.is_public is none %}selected{% endif %}>Any</option>
                 <option value="true" {% if filters.is_public == True %}selected{% endif %}>Public Only</option>
                 <option value="false" {% if filters.is_public == False %}selected{% endif %}>Private Only</option>
            </select>
        </div>
        {# Action Buttons #}
        <div class="col-lg-auto col-md-4 col-sm-12 d-flex justify-content-end gap-2 flex-wrap">
             {% if search_term or filters.plan_type or filters.is_public is not none %}
                 <a href="{{ url_for('diet_plans.list_diet_plans') }}" class="button button-outline button-secondary button-small mt-3">Clear Filters</a>
             {% endif %}
             <button type="submit" class="button button-primary button-small mt-3">Apply Filters</button>
        </div>
    </div>
     {# Hidden inputs for sorting persistence #}
     <input type="hidden" name="sort_by" value="{{ sort_by | default('name') }}">
     <input type="hidden" name="sort_dir" value="{{ sort_dir | default('ASC') }}">
</form>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                         {# Sorting Links Macro #}
                        {% macro sort_link(col_key, col_title) %}
                            {% set current_dir = 'ASC' if sort_by != col_key else ('DESC' if sort_dir == 'ASC' else 'ASC') %}
                            {# Base args for sorting links - include current filters #}
                            {% set base_args_sort = {'page': 1, 'search': search_term, 'filter_type': filters.plan_type, 'filter_public': request.args.get('filter_public', '')} %}
                            <a href="{{ url_for('diet_plans.list_diet_plans', sort_by=col_key, sort_dir=current_dir, **base_args_sort) }}" title="Sort by {{ col_title }}">
                                {{ col_title }}
                                {% if sort_by == col_key %}
                                    <i class="fas {{ 'fa-sort-up' if sort_dir == 'ASC' else 'fa-sort-down' }} sort-icon active"></i>
                                {% else %}
                                    <i class="fas fa-sort sort-icon"></i>
                                {% endif %}
                            </a>
                        {% endmacro %}
                        {# Table Headers with Sorting #}
                        <th style="width: 5%;">{{ sort_link('id', 'ID') }}</th>
                        <th style="width: 30%;">{{ sort_link('name', 'Plan Name') }}</th>
                        <th style="width: 15%;">{{ sort_link('type', 'Type') }}</th>
                        <th style="width: 10%;">{{ sort_link('calories', 'Calories') }}</th>
                        <th style="width: 15%;">{{ sort_link('creator', 'Creator') }}</th>
                        <th style="width: 5%;">Public</th>
                        <th style="width: 10%;">{{ sort_link('updated', 'Updated') }}</th>
                        <th class="text-end" style="width: 10%;">Actions</th>
                    </tr>
                </thead>
                {# templates/Doctor_Portal/DietPlans/diet_plan_list.html #}

{# ... (rest of the template above) ... #}

<tbody>
    {% for plan in plans %}
    <tr>
        <td>{{ plan.plan_id }}</td>
        <td><a href="{{ url_for('.view_diet_plan', plan_id=plan.plan_id) }}"><strong>{{ plan.plan_name }}</strong></a></td>
        <td>{{ plan.plan_type | title }}</td>
        <td>{{ plan.calories | default('-') }}</td>
        <td>
            {% if plan.creator_user_id %}
                {{ plan.creator_first_name }} {{ plan.creator_last_name }}
            {% else %}
                <span class="text-muted">System</span>
            {% endif %}
        </td>
        <td>{% if plan.is_public %}<i class="fas fa-check-circle text-success"></i>{% else %}<i class="fas fa-times-circle text-muted"></i>{% endif %}</td>
        <td>{{ plan.updated_at.strftime('%Y-%m-%d') if plan.updated_at else '-' }}</td> {# Shorter date #}
        <td class="action-buttons text-end">
            <a href="{{ url_for('.view_diet_plan', plan_id=plan.plan_id) }}" class="button button-outline button-small" title="View"><i class="fas fa-eye"></i></a>

            {# --- CORRECTED Logic: Use the can_manage_plans flag from the route --- #}
            {# Check if the current user is a dietitian (can_manage_plans) AND if the plan is public OR they are the creator #}
            {% set is_creator = plan.creator_id == current_user.user_id %}
            {% if can_manage_plans and (plan.is_public or is_creator) %}
                <a href="{{ url_for('.edit_diet_plan', plan_id=plan.plan_id) }}" class="button button-outline button-secondary button-small" title="Edit"><i class="fas fa-edit"></i></a>
                <form action="{{ url_for('.delete_diet_plan', plan_id=plan.plan_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete plan \'{{ plan.plan_name|e }}\'? This cannot be undone.');">
                    <button type="submit" class="button button-outline button-danger button-small" title="Delete"><i class="fas fa-trash"></i></button>
                </form>
            {% endif %}
            {# --- END Corrected Logic --- #}
        </td>
    </tr>
    {% else %}
    <tr>
        <td colspan="8" class="text-center text-muted py-4">No diet plans found matching your criteria.</td>
    </tr>
    {% endfor %}
</tbody>

{# ... (rest of the template below) ... #}
            </table>
        </div>
    </div>
     {# Pagination Controls #}
     {% if total_pages > 1 %}
        <div class="card-footer d-flex justify-content-center">
             <nav aria-label="Diet plan list navigation">
                <ul class="pagination pagination-sm mb-0">
                    {% set base_args_page = {'search': search_term, 'sort_by': sort_by, 'sort_dir': sort_dir, 'filter_type': filters.plan_type, 'filter_public': request.args.get('filter_public', '')} %}
                     {# Previous Page Link #}
                     <li class="page-item {{ 'disabled' if current_page <= 1 else '' }}">
                        <a class="page-link" href="{{ url_for('.list_diet_plans', page=current_page-1, **base_args_page) }}">« Prev</a>
                    </li>
                     {# Page Number Links #}
                     {% set max_links = 5 %}{% set start_page = [1, current_page - (max_links // 2)] | max %}{% set end_page = [total_pages, start_page + max_links - 1] | min %}
                     {% if start_page > 1 %}<li class="page-item"><a class="page-link" href="{{ url_for('.list_diet_plans', page=1, **base_args_page) }}">1</a></li>{% if start_page > 2 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}{% endif %}
                     {% for page_num in range(start_page, end_page + 1) %}<li class="page-item {{ 'active' if page_num == current_page else '' }}"><a class="page-link" href="{{ url_for('.list_diet_plans', page=page_num, **base_args_page) }}">{{ page_num }}</a></li>{% endfor %}
                     {% if end_page < total_pages %}{% if end_page < total_pages - 1 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}<li class="page-item"><a class="page-link" href="{{ url_for('.list_diet_plans', page=total_pages, **base_args_page) }}">{{ total_pages }}</a></li>{% endif %}
                     {# Next Page Link #}
                    <li class="page-item {{ 'disabled' if current_page >= total_pages else '' }}">
                        <a class="page-link" href="{{ url_for('.list_diet_plans', page=current_page+1, **base_args_page) }}">Next »</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
</div>
{% endblock %}