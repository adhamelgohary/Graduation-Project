{% extends "Doctor_Portal/base.html" %}
{% block title %}Diet Plan Assignments{% endblock %}

{% block head_extra %}
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
 <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/disease_catalog.css') }}"> {# Shared styles #}
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Diet Plan Assignments</h1>
    {# Conditionally show Assign button based on dietitian role #}
    {% if can_manage_assignments %}
        <a href="{{ url_for('diet_plans.assign_diet_plan') }}" class="button button-primary">
            <i class="fas fa-plus fa-fw"></i> Assign New Plan
        </a>
    {% endif %}
</div>

{# Display Flash Messages #}
{% include '_flash_messages.html' %}

{# Add Filters/Search Form Here (Optional) #}

<div class="card shadow-sm content-section">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Plan Name</th>
                        <th>Assigned By</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in assignments %}
                    <tr>
                        <td>
                            {# Link to patient profile/progress if route exists #}
                            <a href="{{ url_for('diet_plans.view_nutrition_progress', patient_user_id=assignment.patient_user_id) }}" title="View Progress">
                                {{ assignment.patient_first_name }} {{ assignment.patient_last_name }}
                            </a>
                        </td>
                        <td>
                            <a href="{{ url_for('diet_plans.view_diet_plan', plan_id=assignment.plan_id) }}" title="View Plan Details">
                                {{ assignment.plan_name }}
                            </a>
                        </td>
                        <td>
                            {% if assignment.assigner_first_name %}
                                {{ assignment.assigner_first_name }} {{ assignment.assigner_last_name }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ assignment.start_date.strftime('%Y-%m-%d') if assignment.start_date else 'N/A' }}</td>
                        <td>{{ assignment.end_date.strftime('%Y-%m-%d') if assignment.end_date else 'Ongoing' }}</td>
                        <td>
                            {% if assignment.active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="action-buttons text-end">
                             <a href="{{ url_for('diet_plans.view_nutrition_progress', patient_user_id=assignment.patient_user_id) }}" class="button button-outline button-small" title="View Progress"><i class="fas fa-chart-line"></i></a>
                             {# Conditionally show Deactivate button based on dietitian role #}
                             {% if assignment.active and can_manage_assignments %}
                                <form action="{{ url_for('diet_plans.deactivate_assignment', assignment_id=assignment.user_diet_plan_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Deactivate this assignment?');">
                                    <button type="submit" class="button button-outline button-warning button-small" title="Deactivate Assignment">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                </form>
                             {% endif %}
                              {# Add Edit/Delete Assignment buttons if needed and authorized #}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">No diet plan assignments found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {# Add Pagination Controls Here #}
</div>
{% endblock %}