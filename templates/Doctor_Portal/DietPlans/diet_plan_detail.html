{% extends "Doctor_Portal/base.html" %}
{% block title %}Diet Plan: {{ details.plan.plan_name }}{% endblock %}

{% block head_extra %}
 <style> /* Add styles for meal/item display */
    .meal-block { border: 1px solid #eee; border-radius: 5px; margin-bottom: 1rem; background-color: #fdfdfd;}
    .meal-header { background-color: #f5f5f5; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; font-weight: 600;}
    .meal-body { padding: 1rem; }
    .food-item { border-bottom: 1px dotted #ddd; padding: 0.5rem 0; margin-bottom: 0.5rem; }
    .food-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
    .food-item strong { color: var(--color-primary); }
 </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Diet Plan: {{ details.plan.plan_name }}</h1>
    <div>
        {% if details.plan.is_public or details.plan.creator_id == current_user.user_id %} {# Edit Auth Check #}
        <a href="{{ url_for('.edit_diet_plan', plan_id=details.plan.plan_id) }}" class="button button-outline button-secondary button-small"><i class="fas fa-edit"></i> Edit</a>
         {% endif %}
        {% if details.plan.is_public or details.plan.creator_id == current_user.user_id %} {# Delete Auth Check #}
         <form action="{{ url_for('.delete_diet_plan', plan_id=details.plan.plan_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete plan \'{{ details.plan.plan_name|e }}\'? This cannot be undone.');">
             <button type="submit" class="button button-outline button-danger button-small" title="Delete"><i class="fas fa-trash"></i> Delete</button>
         </form>
         {% endif %}
        <a href="{{ url_for('.list_diet_plans') }}" class="button button-outline button-secondary button-small ms-2"><i class="fas fa-arrow-left"></i> Back to List</a>
    </div>
</div>

<div class="card shadow-sm content-section">
    <div class="card-body">
        {# Display Plan Details (name, type, description, macros, conditions, public, creator) #}
        <p><strong>Type:</strong> {{ details.plan.plan_type | title }}</p>
        <p><strong>Description:</strong> {{ details.plan.description | default('N/A') | nl2br }}</p>
        {# ... Display other fields ... #}
         <p><strong>Target Conditions:</strong> {{ details.plan.target_conditions_list | join(', ') | default('N/A') }}</p>
         <p><strong>Public:</strong> {{ 'Yes' if details.plan.is_public else 'No' }}</p>
         <p><strong>Creator:</strong> {% if details.plan.creator_user_id %} {{ details.plan.creator_first_name }} {{ details.plan.creator_last_name }} {% else %} System {% endif %}</p>


         <hr>
         <h4>Meals & Schedule</h4>
         {% if details.meals %}
             {% for meal in details.meals %}
             <div class="meal-block">
                <div class="meal-header">
                    {{ meal.meal_name | default('Unnamed Meal') }} ({{ meal.meal_type | title }})
                    {% if meal.time_of_day %}<span class="text-muted small ms-2">- {{ meal.time_of_day.strftime('%H:%M') }}</span>{% endif %}
                </div>
                <div class="meal-body">
                     {% if meal.description %}<p><em>{{ meal.description | nl2br }}</em></p>{% endif %}
                     {% if meal.food_items %}
                        {% for item in meal.food_items %}
                        <div class="food-item">
                            <strong>{{ item.food_name }}</strong>: {{ item.serving_size }}
                            {# Display macros if available #}
                            {% if item.notes %}<p class="small text-muted mb-0 mt-1">Notes: {{ item.notes }}</p>{% endif %}
                            {% if item.alternatives %}<p class="small text-info mb-0 mt-1">Alts: {{ item.alternatives }}</p>{% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted small">No food items listed for this meal.</p>
                    {% endif %}
                </div>
             </div>
             {% endfor %}
         {% else %}
            <p class="text-muted">No meals defined for this plan yet.</p>
         {% endif %}
    </div>
</div>
{% endblock %}