{% extends "Doctor_Portal/base.html" %}
{% block title %}Appointment Details{% endblock %}

{% block head_extra %}
<style>
    .detail-grid { display: grid; grid-template-columns: 150px 1fr; gap: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-md); }
    .detail-grid strong { font-weight: 600; color: var(--color-text-muted); text-align: right; }
    .detail-grid .full-width { grid-column: 1 / -1; }
    .detail-grid hr { grid-column: 1 / -1; margin: var(--spacing-md) 0; border: 0; border-top: 1px solid var(--color-border); }
    .action-header { display: flex; justify-content: space-between; align-items: center; }
    #appointment-status-badge { font-size: 1em; vertical-align: middle; margin-left: var(--spacing-sm); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Appointment Details</h1>
    <a href="{{ request.referrer or url_for('.list_appointments') }}" class="button button-outline button-secondary">
        <i class="fas fa-arrow-left fa-fw"></i> Back
    </a>
</div>

<div class="card">
    <div class="card-header action-header">
        <span>
            ID: {{ appointment.appointment_id }} - Status:
            <span id="appointment-status-badge" class="badge {{ 'badge-success' if appointment.status == 'confirmed' else ('badge-secondary' if appointment.status == 'completed' else ('badge-warning' if appointment.status == 'no-show' else ('badge-danger' if appointment.status == 'canceled' else 'badge-info'))) }}">
                {{ appointment.status|capitalize if appointment.status else 'N/A' }}
            </span>
        </span>
         {% if appointment.status not in ['completed', 'canceled', 'no-show'] %}
         <div class="d-flex gap-2"> {# Use flex for button group #}
             <a href="{{ url_for('.reschedule_appointment', appointment_id=appointment.appointment_id) }}" class="button button-warning button-small"><i class="fas fa-calendar-alt fa-fw"></i> Reschedule</a>
             <form action="{{ url_for('.cancel_appointment', appointment_id=appointment.appointment_id) }}" method="post" class="d-inline" onsubmit="return confirm('Cancel this appointment?');">
                 <button type="submit" class="button button-danger button-small"><i class="fas fa-times-circle fa-fw"></i> Cancel</button>
             </form>
         </div>
         {% endif %}
    </div>
    <div class="card-body">
        <div class="detail-grid">
            {# Appointment Info #}
            <strong>Date:</strong>       <div>{{ appointment.appointment_date_str or 'N/A' }}</div>
            <strong>Time:</strong>       <div>{{ appointment.start_time_str or 'N/A' }} - {{ appointment.end_time_str or 'N/A' }}</div>
            <strong>Type:</strong>       <div>{{ appointment.appointment_type|capitalize if appointment.appointment_type else 'N/A' }}</div>
            <strong>Location:</strong>   <div>{{ appointment.location_name or 'N/A' }} {% if appointment.location_address %}<small class="text-muted d-block">{{ appointment.location_address }}</small>{% endif %}</div>

            {# Patient Info #}
            <hr><strong class="full-width">Patient Information</strong>
            <strong>Name:</strong>       <div>{{ appointment.patient_last_name or 'N/A' }}, {{ appointment.patient_first_name or '' }}</div>
            <strong>DOB:</strong>        <div>{{ appointment.date_of_birth.strftime('%Y-%m-%d') if appointment.date_of_birth else 'N/A' }} {% if appointment.patient_age is not none %}(Age: {{ appointment.patient_age }}){% endif %}</div>
            <strong>Gender:</strong>     <div>{{ appointment.gender|capitalize if appointment.gender else 'N/A' }}</div>
            <strong>Email:</strong>      <div>{{ appointment.patient_email or 'N/A' }}</div>
            <strong>Phone:</strong>      <div>{{ appointment.patient_phone or 'N/A' }}</div>

            {# Context & Notes #}
            <hr><strong class="full-width">Appointment Context</strong>
            <strong>Reason:</strong>     <div>{{ appointment.reason or 'N/A' }}</div>
            <strong class="full-width pt-2">Provider Notes:</strong>
            <div class="full-width">
                 <textarea class="form-control" id="appointment_notes" rows="4" {% if appointment.status in ['completed', 'canceled'] %}readonly{% endif %}>{{ appointment.notes or '' }}</textarea>
                 {% if appointment.status not in ['completed', 'canceled'] %}
                 <button id="save-notes-btn" class="button button-outline button-success button-small mt-2"><i class="fas fa-save fa-fw"></i> Save Notes</button>
                 <span id="notes-save-status" class="ms-2 text-muted"></span>
                 {% endif %}
            </div>

             {# Status Update #}
             {% if appointment.status not in ['canceled'] %}
             <hr><strong class="full-width">Actions</strong>
             <strong>Update Status:</strong>
             <div>
                 <select id="update-status-select" class="form-select form-select-sm d-inline-block" style="width: auto;" {% if appointment.status == 'completed' %}disabled{% endif %}>
                     {% for stat in appointment_statuses %}
                         {% if stat != 'canceled' %}
                             <option value="{{ stat }}" {% if stat == appointment.status %}selected{% endif %}>{{ stat|capitalize }}</option>
                         {% endif %}
                     {% endfor %}
                 </select>
                 <button id="update-status-btn" class="button button-outline button-info button-small ms-2" {% if appointment.status == 'completed' %}disabled{% endif %}><i class="fas fa-check fa-fw"></i> Update</button>
                 <span id="status-update-status" class="ms-2 text-muted"></span>
            </div>
            {% endif %}

            {# Metadata #}
            <hr><strong class="full-width">Metadata</strong>
            <strong>Created:</strong>    <div><small>{{ appointment.created_at.strftime('%Y-%m-%d %H:%M') if appointment.created_at else 'N/A' }} by {{ appointment.created_by_username or 'System' }}</small></div>
            <strong>Updated:</strong>    <div><small>{{ appointment.updated_at.strftime('%Y-%m-%d %H:%M') if appointment.updated_at else 'N/A' }} by {{ appointment.updated_by_username or 'System' }}</small></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- JS for Save Notes & Update Status (Needs slight adaptation for badge class) ---
document.addEventListener('DOMContentLoaded', function() {
    const appointmentId = '{{ appointment.appointment_id }}';
    const csrfToken = null; // Add CSRF if needed

    // --- Update Notes ---
    const notesTextarea = document.getElementById('appointment_notes');
    const saveNotesBtn = document.getElementById('save-notes-btn');
    const notesSaveStatus = document.getElementById('notes-save-status');
    if (saveNotesBtn) { /* Keep Existing saveNotesBtn AJAX logic */
        saveNotesBtn.addEventListener('click', async () => {
             const notes = notesTextarea.value; notesSaveStatus.textContent = 'Saving...'; notesSaveStatus.className = 'ms-2 text-muted'; saveNotesBtn.disabled = true;
             try { /* ... fetch POST /update_notes ... */
                const result = await response.json();
                if (result.success) { notesSaveStatus.textContent = 'Saved!'; notesSaveStatus.className = 'ms-2 text-success'; }
                else { notesSaveStatus.textContent = `Error: ${result.message}`; notesSaveStatus.className = 'ms-2 text-danger'; }
            } catch (e) { /* ... error handling ... */ } finally { saveNotesBtn.disabled = false; setTimeout(() => { notesSaveStatus.textContent = ''; }, 3000); }
        });
    }

    // --- Update Status ---
    const statusSelect = document.getElementById('update-status-select');
    const updateStatusBtn = document.getElementById('update-status-btn');
    const statusUpdateStatus = document.getElementById('status-update-status');
    const statusBadge = document.getElementById('appointment-status-badge');
    if (updateStatusBtn) { /* Keep Existing updateStatusBtn AJAX logic, ADAPT BADGE CLASS */
        updateStatusBtn.addEventListener('click', async () => {
            const newStatus = statusSelect.value; statusUpdateStatus.textContent = 'Updating...'; updateStatusBtn.disabled = true; statusSelect.disabled = true;
             try { /* ... fetch POST /update_status ... */
                const result = await response.json();
                if (result.success) {
                    statusUpdateStatus.textContent = 'Updated!'; statusUpdateStatus.className = 'ms-2 text-success';
                    if (statusBadge) {
                        statusBadge.textContent = result.new_status.charAt(0).toUpperCase() + result.new_status.slice(1);
                        // *** Update badge class based on base.css ***
                        let badgeClass = 'badge-info'; // default
                        if (result.new_status === 'confirmed') badgeClass = 'badge-success';
                        else if (result.new_status === 'completed') badgeClass = 'badge-secondary';
                        else if (result.new_status === 'no-show') badgeClass = 'badge-warning';
                        else if (result.new_status === 'canceled') badgeClass = 'badge-danger';
                        statusBadge.className = `badge ${badgeClass}`;
                    }
                    if (['completed', 'canceled', 'no-show'].includes(result.new_status)) {
                        // Disable buttons/selects
                        document.querySelector('a.button-warning')?.classList.add('disabled'); // Reschedule link
                        document.querySelector('button.button-danger')?.setAttribute('disabled', 'disabled'); // Cancel button
                        if(saveNotesBtn) saveNotesBtn.disabled = true; // Disable notes save too
                        if(notesTextarea) notesTextarea.readOnly = true;
                        statusSelect.disabled = true;
                        updateStatusBtn.disabled = true;
                    }
                } else { /* ... error handling, revert select value ... */ statusUpdateStatus.textContent = `Error: ${result.message}`; statusUpdateStatus.className = 'ms-2 text-danger'; statusSelect.value = "{{ appointment.status }}"; }
             } catch (e) { /* ... error handling ... */ statusSelect.value = "{{ appointment.status }}"; }
              finally { /* Re-enable if not final status */
                  if (!['completed', 'canceled', 'no-show'].includes(statusSelect.value)) { updateStatusBtn.disabled = false; statusSelect.disabled = false; }
                   setTimeout(() => { statusUpdateStatus.textContent = ''; }, 3000);
              }
        });
    }
});
</script>
{% endblock %}