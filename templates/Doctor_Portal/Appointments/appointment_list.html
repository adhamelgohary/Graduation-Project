{% extends "Doctor_Portal/base.html" %}
{% block title %}Appointments{% endblock %}

{% block head_extra %}
<style>
    .filter-form .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: var(--spacing-md);
        align-items: end;
    }
    .filter-form .actions { grid-column: 1 / -1; /* Span full width on small screens */ }
     @media (min-width: 992px) {
         .filter-form .actions { grid-column: auto; /* Reset span */ }
     }
    .pagination { list-style: none; display: flex; justify-content: center; padding: 0; margin-top: var(--spacing-lg); gap: var(--spacing-xs); }
    .pagination li a, .pagination li span { display: inline-block; padding: 0.4rem 0.8rem; border: 1px solid var(--color-border); color: var(--color-primary); text-decoration: none; border-radius: var(--border-radius); background-color: var(--color-surface); }
    .pagination li a:hover { background-color: #e9ecef; }
    .pagination li.active a, .pagination li.active span { background-color: var(--color-primary); color: var(--color-text-light); border-color: var(--color-primary); }
    .pagination li.disabled a, .pagination li.disabled span { color: var(--color-text-muted); background-color: #e9ecef; pointer-events: none; border-color: var(--color-border); }
    .table th a { color: inherit; text-decoration: none; }
    .table th a:hover { color: var(--color-primary); }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>My Appointments</h1>
    <div class="header-actions">
        <a href="{{ url_for('.calendar_view') }}" class="button button-outline button-info">
             <i class="fas fa-calendar-day fa-fw"></i> Calendar View
        </a>
        <a href="{{ url_for('.create_appointment') }}" class="button button-success">
            <i class="fas fa-plus fa-fw"></i> Create Appointment
        </a>
    </div>
</div>

{# --- Filter and Search Form --- #}
<div class="card mb-4 filter-form">
    <div class="card-header">Filter & Search Appointments</div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('.list_appointments') }}">
             {# Preserve existing sort parameters #}
             <input type="hidden" name="sort_by" value="{{ sort_by }}">
             <input type="hidden" name="sort_dir" value="{{ sort_dir }}">

            <div class="form-grid">
                <div>
                    <label for="view" class="form-label">View</label>
                    <select name="view" id="view" class="form-select" onchange="this.form.submit()">
                        <option value="upcoming" {% if view_mode == 'upcoming' %}selected{% endif %}>Upcoming</option>
                        <option value="today" {% if view_mode == 'today' %}selected{% endif %}>Today</option>
                        <option value="week" {% if view_mode == 'week' %}selected{% endif %}>This Week</option>
                        <option value="month" {% if view_mode == 'month' %}selected{% endif %}>This Month</option>
                        <option value="past" {% if view_mode == 'past' %}selected{% endif %}>Past</option>
                        <option value="custom" {% if view_mode == 'custom' %}selected{% endif %}>Custom Range</option>
                    </select>
                </div>
                <div>
                    <label for="start_date" class="form-label">Start Date</label>
                    <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date_str or '' }}">
                </div>
                <div>
                    <label for="end_date" class="form-label">End Date</label>
                    <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date_str or '' }}">
                </div>
                <div>
                    <label for="search" class="form-label">Search</label>
                    <input type="search" name="search" id="search" class="form-control" value="{{ search_term or '' }}" placeholder="Patient, email, reason...">
                </div>
                <div>
                    <label for="status" class="form-label">Status</label>
                    <select name="status" id="status" class="form-select" multiple size="3">
                        {% for stat in appointment_statuses %}
                            <option value="{{ stat }}" {% if stat in filter_statuses %}selected{% endif %}>{{ stat|capitalize }}</option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">Ctrl/Cmd+click for multiple.</small>
                </div>
                <div>
                    <label for="appointment_type" class="form-label">Type</label>
                    <select name="appointment_type" id="appointment_type" class="form-select">
                        <option value="">Any Type</option>
                        {% for type in appointment_types %}
                            <option value="{{ type }}" {% if type == filter_type %}selected{% endif %}>{{ type|capitalize }}</option>
                        {% endfor %}
                    </select>
               </div>
               <div class="actions d-flex gap-2">
                    <button type="submit" class="button button-primary"><i class="fas fa-filter fa-fw"></i> Filter</button>
                    <a href="{{ url_for('.list_appointments', view='upcoming') }}" class="button button-secondary"><i class="fas fa-undo fa-fw"></i> Reset</a>
                </div>
            </div>
        </form>
    </div>
</div>

{# --- Appointments Table --- #}
<div class="table-responsive card"> {# Wrap table in card for consistency #}
    <table class="table">
        <thead>
            <tr>
                {% macro sortable_th(col_key, display_name) %}
                    {% set current_sort_dir = 'DESC' if sort_by == col_key and sort_dir == 'ASC' else 'ASC' %}
                    {% set url_params = request.args.to_dict() %}
                    {% set _ = url_params.update({'sort_by': col_key, 'sort_dir': current_sort_dir}) %}
                    <th>
                        <a href="{{ url_for(request.endpoint, **url_params) }}">
                            {{ display_name }}
                            {% if sort_by == col_key %}<i class="fas fa-sort-{{ 'up' if sort_dir == 'ASC' else 'down' }} ms-1"></i>{% endif %}
                        </a>
                    </th>
                {% endmacro %}

                {{ sortable_th('date', 'Date & Time') }}
                {{ sortable_th('patient', 'Patient') }}
                {{ sortable_th('type', 'Type') }}
                {{ sortable_th('status', 'Status') }}
                <th>Reason</th>
                {{ sortable_th('location', 'Location') }}
                <th class="text-end">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if appointments %}
                {% for appt in appointments %}
                <tr>
                    <td>
                        {{ appt.appointment_date_str or 'N/A' }}<br>
                        <small>{{ appt.start_time_str or 'N/A' }} - {{ appt.end_time_str or 'N/A' }}</small>
                    </td>
                    <td>{{ appt.patient_last_name or 'N/A' }}, {{ appt.patient_first_name or '' }}</td>
                    <td>{{ appt.appointment_type|capitalize if appt.appointment_type else 'N/A' }}</td>
                    <td>
                        {# Use custom badge classes from base.css #}
                        <span class="badge {{ 'badge-success' if appt.status == 'confirmed' else ('badge-secondary' if appt.status == 'completed' else ('badge-warning' if appt.status == 'no-show' else ('badge-danger' if appt.status == 'canceled' else 'badge-info'))) }}">
                            {{ appt.status|capitalize if appt.status else 'N/A' }}
                        </span>
                    </td>
                    <td>{{ appt.reason[:50] + '...' if appt.reason and appt.reason|length > 50 else (appt.reason or '-') }}</td>
                    <td>{{ appt.location_name or 'N/A' }}</td>
                    <td class="action-buttons"> {# Align buttons right #}
                         <a href="{{ url_for('.view_appointment', appointment_id=appt.appointment_id) }}" class="button button-outline button-info button-small" title="View Details">
                             <i class="fas fa-eye fa-fw"></i> View
                         </a>
                         {% if appt.status not in ['completed', 'canceled', 'no-show'] %}
                            <a href="{{ url_for('.reschedule_appointment', appointment_id=appt.appointment_id) }}" class="button button-outline button-warning button-small" title="Reschedule">
                                <i class="fas fa-calendar-alt fa-fw"></i> Reschedule
                            </a>
                            <form action="{{ url_for('.cancel_appointment', appointment_id=appt.appointment_id) }}" method="post" class="d-inline" onsubmit="return confirm('Cancel this appointment?');">
                                <button type="submit" class="button button-outline button-danger button-small" title="Cancel">
                                    <i class="fas fa-times-circle fa-fw"></i> Cancel
                                </button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted p-4">No appointments found matching your criteria.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>


{% if total_items > 0 %}
    <p class="text-center text-muted"> {{ total_items }} appointment(s) found.</p>
{% endif %}

{% endblock %}

{% block scripts %}
{# Keep the date range toggle JS if needed for 'custom' view #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const viewSelect = document.getElementById('view');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    function toggleDateInputs() {
        const isCustom = viewSelect.value === 'custom';
        startDateInput.disabled = !isCustom;
        endDateInput.disabled = !isCustom;
    }
    if (viewSelect) { toggleDateInputs(); viewSelect.addEventListener('change', toggleDateInputs); }
});
</script>
{% endblock %}