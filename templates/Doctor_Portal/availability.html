{% extends "Doctor_Portal/base.html" %}

{% block title %}Manage Availability{% endblock %}

{% block head_extra %}
    {# Optional: Add CSS specific to this page if needed #}
    {# <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/availability.css') }}"> #}
    <style>
        /* Basic styling for the availability page */
        .availability-section {
            margin-bottom: var(--spacing-xl);
        }
        .weekly-schedule-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-lg);
        }
        .day-column h4 {
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: var(--spacing-xs);
            margin-bottom: var(--spacing-md);
            font-size: 1.1rem;
        }
        .time-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #e9ecef;
            padding: var(--spacing-sm);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-sm);
            font-size: 0.9rem;
        }
        .time-slot span {
            font-weight: 500;
        }
        .delete-btn {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0 5px;
        }
        .delete-btn:hover {
            color: darkred;
        }
        .override-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: var(--spacing-sm) 0;
             border-bottom: 1px solid var(--color-border);
        }
         .override-item:last-child {
             border-bottom: none;
         }
        .override-details span { display: inline-block; margin-right: var(--spacing-md); min-width: 100px;}
        .override-details .reason { font-style: italic; color: var(--color-text-muted);}
        .status-unavailable { color: var(--color-danger); font-weight: bold; }
        .status-available { color: var(--color-accent); font-weight: bold; }

         /* Simple form layout */
        .availability-form .form-row {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap; /* Wrap on smaller screens */
        }
         .availability-form .form-group {
            flex: 1; /* Allow items to grow */
            min-width: 150px; /* Minimum width before wrapping */
            margin-bottom: 0; /* Remove default margin */
        }
         .availability-form .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em;}
         .availability-form .form-group input,
         .availability-form .form-group select { width: 100%; }
         .availability-form .button { margin-top: var(--spacing-sm); } /* Align button better */

    </style>
{% endblock %}

{% block content %}
<h1>Manage Availability</h1>

{# ========== Weekly Schedule Section ========== #}
<div class="availability-section card">
    <div class="card-header">Recurring Weekly Schedule</div>
    <div class="card-body">
        <p class="text-muted mb-3">Define your standard working hours for each day of the week.</p>

        {# --- Form to Add Weekly Slot --- #}
        <form id="add-weekly-slot-form" class="availability-form mb-4">
            <div class="form-row">
                <div class="form-group">
                    <label for="day_of_week">Day</label>
                    <select id="day_of_week" name="day_of_week" class="form-control" required>
                        <option value="1">Monday</option>
                        <option value="2">Tuesday</option>
                        <option value="3">Wednesday</option>
                        <option value="4">Thursday</option>
                        <option value="5">Friday</option>
                        <option value="6">Saturday</option>
                        <option value="0">Sunday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="start_time">Start Time</label>
                    <input type="time" id="start_time" name="start_time" class="form-control" required step="900"> {# step="900" for 15min increments #}
                </div>
                <div class="form-group">
                    <label for="end_time">End Time</label>
                    <input type="time" id="end_time" name="end_time" class="form-control" required step="900">
                </div>
                <div class="form-group" style="align-self: flex-end;"> {# Align button vertically #}
                     <button type="submit" class="button button-primary button-small">Add Slot</button>
                </div>
            </div>
        </form>
         <div id="weekly-form-feedback" class="mb-3"></div> {# For AJAX messages #}

        {# --- Display Existing Weekly Slots --- #}
        <div class="weekly-schedule-grid">
            {% for day_num, day_name in enumerate(days_of_week) %}
                {# Adjust day_num if your list starts Sunday=0 #}
                 {% set current_day_num = (day_num + 0) % 7 %} {# Adjust index based on your days_of_week list order #}
                 <div class="day-column">
                    <h4>{{ day_name }}</h4>
                    <div id="day-{{ current_day_num }}-slots">
                        {% if schedule[current_day_num] %}
                            {% for slot in schedule[current_day_num] %}
                            <div class="time-slot" id="slot-{{ slot.availability_id }}">
                                <span>{{ slot.start_time }} - {{ slot.end_time }}</span>
                                <button class="delete-btn delete-weekly-slot" data-slot-id="{{ slot.availability_id }}" title="Delete Slot">×</button>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted no-slots">No availability set.</p>
                        {% endif %}
                    </div>
                 </div>
            {% endfor %}
        </div>
    </div>
</div>

{# ========== Overrides Section ========== #}
<div class="availability-section card">
    <div class="card-header">Date Specific Overrides</div>
     <div class="card-body">
        <p class="text-muted mb-3">Block specific dates/times (vacations, holidays) or mark specific times as available.</p>

        {# --- Form to Add Override --- #}
        <form id="add-override-form" class="availability-form mb-4">
             <div class="form-row">
                 <div class="form-group">
                     <label for="override_date">Date</label>
                     <input type="date" id="override_date" name="override_date" class="form-control" required>
                 </div>
                 <div class="form-group">
                     <label for="override_type">Type</label>
                     <select id="override_type" name="is_unavailable" class="form-control">
                         <option value="true" selected>Unavailable (Block Time)</option>
                         <option value="false">Available (Specific Slot)</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label for="override_start_time">Start Time (Optional)</label>
                     <input type="time" id="override_start_time" name="start_time" class="form-control" step="900">
                     <small class="text-muted">Leave blank for full day</small>
                 </div>
                 <div class="form-group">
                     <label for="override_end_time">End Time (Optional)</label>
                     <input type="time" id="override_end_time" name="end_time" class="form-control" step="900">
                 </div>
             </div>
             <div class="form-row">
                 <div class="form-group" style="flex-grow: 2;"> {# Make reason wider #}
                     <label for="override_reason">Reason (Optional)</label>
                     <input type="text" id="override_reason" name="reason" class="form-control" placeholder="e.g., Vacation, Conference">
                 </div>
                 <div class="form-group" style="align-self: flex-end;">
                     <button type="submit" class="button button-primary button-small">Add Override</button>
                 </div>
            </div>
        </form>
         <div id="override-form-feedback" class="mb-3"></div> {# For AJAX messages #}


        {# --- Display Existing Overrides --- #}
        <h4>Existing Overrides (Next 30 Days)</h4> {# TODO: Add date range filter? #}
        <div id="override-list">
            {% if overrides %}
                {% for override in overrides %}
                    <div class="override-item" id="override-{{ override.override_id }}">
                        <div class="override-details">
                            <span><strong>Date:</strong> {{ override.override_date }}</span>
                            {% if override.start_time and override.end_time %}
                                <span><strong>Time:</strong> {{ override.start_time }} - {{ override.end_time }}</span>
                            {% else %}
                                <span><strong>Time:</strong> Full Day</span>
                            {% endif %}
                             <span class="{{ 'status-unavailable' if override.is_unavailable else 'status-available' }}">
                                {{ 'Unavailable' if override.is_unavailable else 'Specifically Available' }}
                             </span>
                            {% if override.reason %}
                                <span class="reason">({{ override.reason }})</span>
                            {% endif %}
                        </div>
                        <button class="delete-btn delete-override" data-override-id="{{ override.override_id }}" title="Delete Override">×</button>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-muted no-overrides">No overrides found for the selected period.</p>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const weeklyForm = document.getElementById('add-weekly-slot-form');
    const overrideForm = document.getElementById('add-override-form');
    const weeklyFeedback = document.getElementById('weekly-form-feedback');
    const overrideFeedback = document.getElementById('override-form-feedback');

    // Function to display feedback messages
    function showFeedback(element, message, isSuccess) {
        element.innerHTML = `<div class="alert alert-${isSuccess ? 'success' : 'danger'}">${message}</div>`;
        setTimeout(() => { element.innerHTML = ''; }, 5000); // Clear after 5 seconds
    }

    // --- Handle Add Weekly Slot ---
    if (weeklyForm) {
        weeklyForm.addEventListener('submit', function(event) {
            event.preventDefault();
            weeklyFeedback.innerHTML = ''; // Clear previous feedback
            const formData = new FormData(weeklyForm);

            fetch('{{ url_for("doctor_main.add_weekly_slot_route") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showFeedback(weeklyFeedback, data.message, data.success);
                if (data.success && data.slot) {
                    addSlotToDOM(data.slot); // Add the new slot visually
                    weeklyForm.reset(); // Reset the form
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFeedback(weeklyFeedback, 'An error occurred submitting the form.', false);
            });
        });
    }

    // --- Handle Delete Weekly Slot ---
    document.body.addEventListener('click', function(event) {
        if (event.target.matches('.delete-weekly-slot')) {
            const button = event.target;
            const slotId = button.dataset.slotId;
            if (!slotId || !confirm('Are you sure you want to delete this weekly slot?')) {
                return;
            }

            fetch(`/doctor/availability/weekly/${slotId}`, { // Use backticks if needed, ensure URL is correct
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                    // Add CSRF token header if using Flask-WTF/CSRFProtect
                }
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data }))) // Keep status and body
            .then(({ status, body }) => {
                if (body.success) {
                    const slotElement = document.getElementById(`slot-${slotId}`);
                    if (slotElement) {
                        slotElement.remove();
                        // Check if the parent day column is now empty
                        const parentDiv = document.getElementById(`day-${body.slot?.day_of_week ?? getDayFromSlotId(slotId)}-slots`); // Need a way to know the day or query parent
                        if (parentDiv && !parentDiv.querySelector('.time-slot')) {
                             parentDiv.innerHTML = '<p class="text-muted no-slots">No availability set.</p>';
                        }
                    }
                     // Optionally show flash message via JS or rely on Flask's flash after reload
                     // For now, just log success
                     console.log("Slot deleted successfully");
                     flashMessage("Weekly slot deleted.", "success"); // Use a custom flash function if available
                } else {
                    console.error('Deletion failed:', body.message);
                    flashMessage(body.message || 'Failed to delete slot.', "danger");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                 flashMessage('An error occurred during deletion.', "danger");
            });
        }
    });


    // --- Handle Add Override ---
     if (overrideForm) {
        overrideForm.addEventListener('submit', function(event) {
            event.preventDefault();
            overrideFeedback.innerHTML = '';
            const formData = new FormData(overrideForm);

            // Basic client-side check for times
             const startTime = formData.get('start_time');
             const endTime = formData.get('end_time');
             if ((startTime && !endTime) || (!startTime && endTime)) {
                 showFeedback(overrideFeedback, 'Please provide both start and end times, or leave both blank for a full day override.', false);
                 return;
             }
              if (startTime && endTime && startTime >= endTime) {
                 showFeedback(overrideFeedback, 'Start time must be before end time.', false);
                 return;
             }


            fetch('{{ url_for("doctor_main.add_override_route") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showFeedback(overrideFeedback, data.message, data.success);
                if (data.success && data.override) {
                    addOverrideToDOM(data.override);
                    overrideForm.reset();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFeedback(overrideFeedback, 'An error occurred submitting the form.', false);
            });
        });
    }

     // --- Handle Delete Override ---
      document.body.addEventListener('click', function(event) {
        if (event.target.matches('.delete-override')) {
            const button = event.target;
            const overrideId = button.dataset.overrideId;
            if (!overrideId || !confirm('Are you sure you want to delete this override?')) {
                return;
            }

            fetch(`/doctor/availability/override/${overrideId}`, {
                method: 'DELETE',
                 headers: { 'Accept': 'application/json' }
                 // Add CSRF token header if needed
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(({ status, body }) => {
                if (body.success) {
                    const overrideElement = document.getElementById(`override-${overrideId}`);
                    if (overrideElement) {
                        overrideElement.remove();
                         // Check if the list is now empty
                         const parentDiv = document.getElementById('override-list');
                         if (parentDiv && !parentDiv.querySelector('.override-item')) {
                             parentDiv.innerHTML = '<p class="text-muted no-overrides">No overrides found for the selected period.</p>';
                         }
                    }
                    console.log("Override deleted successfully");
                    flashMessage("Override deleted.", "success"); // Use a custom flash function if available
                } else {
                     console.error('Deletion failed:', body.message);
                     flashMessage(body.message || 'Failed to delete override.', "danger");
                }
            })
            .catch(error => {
                console.error('Error:', error);
                 flashMessage('An error occurred during deletion.', "danger");
            });
        }
    });


    // --- Helper functions to update DOM ---
    function addSlotToDOM(slot) {
        const dayContainer = document.getElementById(`day-${slot.day_of_week}-slots`);
        if (!dayContainer) return;

        // Remove "No availability" message if present
        const noSlotsMsg = dayContainer.querySelector('.no-slots');
        if (noSlotsMsg) noSlotsMsg.remove();

        const div = document.createElement('div');
        div.classList.add('time-slot');
        div.id = `slot-${slot.availability_id}`;
        div.innerHTML = `
            <span>${slot.start_time} - ${slot.end_time}</span>
            <button class="delete-btn delete-weekly-slot" data-slot-id="${slot.availability_id}" title="Delete Slot">×</button>
        `;
        dayContainer.appendChild(div);
        // TODO: Insert in sorted order? For now, just appends.
    }

    function addOverrideToDOM(override) {
        const listContainer = document.getElementById('override-list');
        if (!listContainer) return;

        const noOverridesMsg = listContainer.querySelector('.no-overrides');
        if (noOverridesMsg) noOverridesMsg.remove();

        const div = document.createElement('div');
        div.classList.add('override-item');
        div.id = `override-${override.override_id}`;

        let timeHtml = override.start_time && override.end_time
            ? `<span><strong>Time:</strong> ${override.start_time} - ${override.end_time}</span>`
            : `<span><strong>Time:</strong> Full Day</span>`;

        let statusClass = override.is_unavailable ? 'status-unavailable' : 'status-available';
        let statusText = override.is_unavailable ? 'Unavailable' : 'Specifically Available';
        let reasonHtml = override.reason ? `<span class="reason">(${override.reason})</span>` : '';

        div.innerHTML = `
            <div class="override-details">
                <span><strong>Date:</strong> ${override.override_date}</span>
                ${timeHtml}
                 <span class="${statusClass}">${statusText}</span>
                ${reasonHtml}
            </div>
            <button class="delete-btn delete-override" data-override-id="${override.override_id}" title="Delete Override">×</button>
        `;
        listContainer.appendChild(div);
         // TODO: Insert in sorted order by date? For now, just appends.
    }

    // Basic Flash message function (replace with your actual implementation if using a library)
     function flashMessage(message, category = 'info') {
        const flashContainer = document.querySelector('.flash-messages'); // Assuming you have this container from base.html
        if (!flashContainer) {
             console.warn("Flash message container not found. Message:", message);
             return;
         }

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category}`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="close-alert" onclick="this.parentElement.style.display='none';" aria-label="Close">×</button>
        `;
        // Prepend to show newest first
        flashContainer.insertBefore(alertDiv, flashContainer.firstChild);

         // Optional: Auto-dismiss after a while
         setTimeout(() => {
             alertDiv.style.opacity = '0';
             setTimeout(() => alertDiv.remove(), 500); // Remove after fade out
         }, 5000); // 5 seconds
     }

    // Helper to get day number (this is crude, better if day is returned in delete response)
    function getDayFromSlotId(slotId) {
        const slotElement = document.getElementById(`slot-${slotId}`);
        if (!slotElement) return null;
        const parentDayDiv = slotElement.closest('[id^="day-"]');
        if (!parentDayDiv) return null;
        try {
            return parseInt(parentDayDiv.id.split('-')[1], 10);
        } catch (e) {
            return null;
        }
    }

});
</script>
{% endblock %}