{# templates/Doctor_Portal/Diseases/disease_detail.html - VIEW ONLY Associations #}
{% extends "Doctor_Portal/base.html" %}

{% block title %}Condition Details: {{ details.condition.condition_name }}{% endblock %}

{% block head_extra %}
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}"> {# Add this if using CSRF #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/disease_catalog.css') }}">
    <style>
        .detail-section { margin-bottom: var(--spacing-lg); }
        .detail-label { font-weight: 600; color: var(--color-secondary); font-size: 0.9em; margin-bottom: 0.1rem; display: block;}
        .detail-value { margin-bottom: var(--spacing-md); color: var(--color-text); font-size: 1rem; }
        .detail-value p:last-child { margin-bottom: 0; } /* Remove extra margin if using paragraphs */
        .detail-value.pre-wrap { white-space: pre-wrap; word-wrap: break-word; } /* For textareas */
        .association-list { list-style: none; padding: 0; margin-top: var(--spacing-sm);}
        /* Removed add-association-form styling */
        .association-item { background-color: #f9f9f9; border: 1px solid #eee; border-radius: var(--border-radius); padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-sm); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .association-item strong { color: var(--color-primary); }
        .association-item small { color: var(--color-text-muted); margin-left: var(--spacing-md); }
        /* Removed remove-association-btn styling */
        .disease-image { max-width: 250px; max-height: 200px; object-fit: cover; border: 1px solid #ddd; padding: 3px; border-radius: var(--border-radius); margin-top: 5px;}
        .doctor-list li { margin-bottom: 0.5rem; }
        .flash-messages-container { position: fixed; top: 80px; right: 20px; z-index: 1050; width: 350px; } /* Keep for AJAX flash if needed */
        .flash-messages-container .alert { margin-bottom: 10px; }
        .no-associations { color: var(--color-text-muted); font-style: italic; margin-top: 0.5rem;} /* Added styling */
    </style>
{% endblock %}

{% block content %}
{# Fixed container for flash messages generated by AJAX (Could be removed if no other AJAX on page) #}
<div class="flash-messages-container"></div>

<div class="page-header">
    <h1>Condition: {{ details.condition.condition_name }}</h1>
    <div>
        <a href="{{ url_for('disease_management.edit_disease', condition_id=details.condition.condition_id) }}" class="button button-outline button-secondary button-small">
            <i class="fas fa-edit fa-fw"></i> Edit Condition (Manage Links Here)
        </a>
        {# Deactivate Form - Needs JS confirmation #}
        <form id="deactivate-form" action="{{ url_for('disease_management.deactivate_disease', condition_id=details.condition.condition_id) }}" method="POST" class="d-inline">
             <button type="submit" class="button button-outline button-danger button-small" title="Deactivate Condition">
                 <i class="fas fa-times-circle fa-fw"></i> Deactivate
             </button>
         </form>
         <a href="{{ url_for('disease_management.list_diseases') }}" class="button button-outline button-secondary button-small ms-2">
            <i class="fas fa-arrow-left fa-fw"></i> Catalog
        </a>
    </div>
</div>

<div class="row gy-4">
    {# Left Column: Basic Info, Details, Image #}
    <div class="col-lg-7">
        <div class="card shadow-sm content-section h-100">
             <div class="card-header"><h4><i class="fas fa-info-circle"></i> Condition Details</h4></div>
            <div class="card-body">
                {# --- Condition Details (Unchanged) --- #}
                <div class="row mb-3">
                    <div class="col-md-8">
                        <span class="detail-label">Condition Name</span>
                        <div class="detail-value"><strong>{{ details.condition.condition_name }}</strong></div>
                    </div>
                    <div class="col-md-4">
                        <span class="detail-label">ICD Code</span>
                        <div class="detail-value">{{ details.condition.icd_code | default('N/A') }}</div>
                    </div>
                </div>
                 <div class="mb-3">
                    <span class="detail-label">Description</span>
                    <div class="detail-value pre-wrap">{{ details.condition.description | default('No description provided.') }}</div>
                </div>
                 <hr>
                 <div class="row">
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Urgency</span> <div class="detail-value urgency-{{ details.condition.urgency_level | lower }}">{{ details.condition.urgency_level | title }}</div> </div>
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Type</span> <div class="detail-value">{{ details.condition.condition_type | title | default('-') }}</div> </div>
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Gender Relevance</span> <div class="detail-value">{{ details.condition.gender_relevance | title }}</div> </div>
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Self-Treatable</span> <div class="detail-value">{{ 'Yes' if details.condition.self_treatable else 'No' }}</div> </div>
                    <div class="col-md-4 col-6 mb-3"> <span class="detail-label">Age Relevance</span> <div class="detail-value">{{ details.condition.age_relevance | default('Any') }}</div> </div>
                    <div class="col-md-4 col-6 mb-3"> <span class="detail-label">Specialist</span> <div class="detail-value">{{ details.condition.specialist_type | default('N/A') }}</div> </div>
                    <div class="col-md-4 col-6 mb-3"> <span class="detail-label">Typical Duration</span> <div class="detail-value">{{ details.condition.typical_duration | default('Variable') }}</div> </div>
                 </div>
                 <hr>
                 <div class="mb-3">
                    <span class="detail-label">Overview</span>
                    <div class="detail-value pre-wrap">{{ details.condition.overview | default('N/A') }}</div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Common Symptoms (Text)</span>
                    <div class="detail-value pre-wrap">{{ details.condition.symptoms_text | default('N/A') }}</div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Potential Causes (Text)</span>
                    <div class="detail-value pre-wrap">{{ details.condition.causes_text | default('N/A') }}</div>
                 </div>
                 <hr>
                 <div class="row">
                     <div class="col-md-6 mb-3">
                         <span class="detail-label">Primary Testing Type</span>
                         <div class="detail-value">{{ details.condition.testing_type_name | default('N/A') }}</div>
                     </div>
                     <div class="col-md-6 mb-3">
                         <span class="detail-label">Primary Diagnosis Method</span>
                         <div class="detail-value">{{ details.condition.diagnosis_type_name | default('N/A') }}</div>
                     </div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Testing Details</span>
                    <div class="detail-value pre-wrap">{{ details.condition.testing_details | default('N/A') }}</div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Diagnosis Details</span>
                    <div class="detail-value pre-wrap">{{ details.condition.diagnosis_details | default('N/A') }}</div>
                 </div>
                 <hr>
                <div class="mb-3">
                     <span class="detail-label">Patient Education / Links</span>
                     <div class="detail-value pre-wrap">{{ details.condition.educational_content | default('None provided.') | urlize(40, true) }}</div>
                </div>
                 {% if details.condition.disease_image_filename %}
                 <div class="mb-3">
                    <span class="detail-label">Image</span><br>
                    <a href="{{ url_for('uploaded_disease_image', filename=details.condition.disease_image_filename) }}" target="_blank">
                       <img src="{{ url_for('uploaded_disease_image', filename=details.condition.disease_image_filename) }}" alt="{{ details.condition.condition_name }} Image" class="disease-image">
                    </a>
                 </div>
                 {% endif %}
            </div>
        </div>
    </div> {# End Left Column #}

    {# Right Column: Associations, Doctors #}
    <div class="col-lg-5">
        <div class="vstack gap-4"> {# Use vstack for vertical spacing #}

            {# Associated Symptoms - Display Only #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-head-side-cough"></i> Associated Symptoms</h5></div>
                <div class="card-body">
                    <ul class="association-list" id="associated-symptoms-list">
                        {% set items = details.symptoms %}
                        {% set id_field = 'symptom_id' %}
                        {% set name_field = 'symptom_name' %}
                        {% set type = 'symptom' %}
                        {% set details_template = '(W: %g, Req: %s)' %}
                        {% set link_field = none %}
                        {% for item in items %}
                            <li class="association-item" id="link-{{ type }}-{{ item[id_field] }}">
                                <span>
                                    <strong>{{ item[name_field] }}</strong>
                                    {% set item_details = '' %}
                                    {% if type == 'symptom' %}
                                        {% set weight_val = item.weight | default(1.0) %}
                                        {% set required_val = 'Yes' if item.is_required else 'No' %}
                                        {% set item_details = details_template|format(weight_val, required_val) %}
                                    {% endif %}
                                    <small> {{ item_details }}</small>
                                    {# No link field #}
                                </span>
                                {# --- REMOVED Remove Button --- #}
                            </li>
                        {% else %} {# Use else with for loop #}
                           <li><p class="no-associations">No symptoms currently linked.</p></li>
                        {% endfor %}
                    </ul>
                    {# --- REMOVED Add Form --- #}
                </div>
            </div>

            {# Associated Risk Factors - Display Only #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-exclamation-triangle"></i> Associated Risk Factors</h5></div>
                <div class="card-body">
                     <ul class="association-list" id="associated-risk_factors-list">
                        {% set items = details.risk_factors %}
                        {% set id_field = 'factor_id' %}
                        {% set name_field = 'factor_name' %}
                        {% set type = 'risk_factor' %}
                        {% set details_template = '(Type: %s, W: %g)' %}
                        {% set link_field = none %}
                        {% for item in items %}
                            <li class="association-item" id="link-{{ type }}-{{ item[id_field] }}">
                                <span>
                                    <strong>{{ item[name_field] }}</strong>
                                    {% set item_details = '' %}
                                    {% if type == 'risk_factor' %}
                                         {% set type_val = item.factor_type | title | default('N/A') %}
                                         {% set weight_val = item.weight | default(1.0) %}
                                         {% set item_details = details_template|format(type_val, weight_val) %}
                                    {% endif %}
                                    <small> {{ item_details }}</small>
                                    {# No link field #}
                                </span>
                                {# --- REMOVED Remove Button --- #}
                            </li>
                         {% else %}
                            <li><p class="no-associations">No risk factors currently linked.</p></li>
                         {% endfor %}
                    </ul>
                    {# --- REMOVED Add Form --- #}
                </div>
            </div>

            {# Associated Protocols - Display Only #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-clipboard-list"></i> Associated Treatment Protocols</h5></div>
                <div class="card-body">
                    <ul class="association-list" id="associated-protocols-list">
                        {% set items = details.protocols %}
                        {% set id_field = 'protocol_id' %}
                        {% set name_field = 'protocol_name' %}
                        {% set type = 'protocol' %}
                        {% set details_template = '(Rel: %s)' %}
                        {% set link_field = 'guideline_url' %}
                        {% for item in items %}
                            <li class="association-item" id="link-{{ type }}-{{ item[id_field] }}">
                                <span>
                                    <strong>{{ item[name_field] }}</strong>
                                    {% set item_details = '' %}
                                    {% if type == 'protocol' %}
                                         {% set relevance_val = item.relevance | title | default('N/A') %}
                                         {% set item_details = details_template|format(relevance_val) %}
                                    {% endif %}
                                    <small> {{ item_details }}</small>
                                    {% if link_field and item[link_field] %}
                                         <a href="{{ item[link_field] }}" target="_blank" title="View Link" class="ms-2"><i class="fas fa-external-link-alt fa-xs"></i></a>
                                    {% endif %}
                                </span>
                                {# --- REMOVED Remove Button --- #}
                            </li>
                         {% else %}
                           <li><p class="no-associations">No protocols currently linked.</p></li>
                         {% endfor %}
                    </ul>
                   {# --- REMOVED Add Form --- #}
                </div>
            </div>

             {# Associated Doctors (Unchanged - Just Display) #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-user-md"></i> Associated Doctors</h5></div>
                <div class="card-body">
                    <span class="detail-label">Department</span>
                    <div class="detail-value mb-3">{{ details.condition.department_name or 'N/A' }}</div>
                    {% if details.associated_doctors %}
                      <ul class="list-unstyled doctor-list">
                        {% for doctor in details.associated_doctors %}
                          <li>
                            <i class="fas fa-user-md fa-fw text-muted"></i>
                                Dr. {{ doctor.first_name }} {{ doctor.last_name }}
                             {% if doctor.email %} <small class="text-muted"> - {{ doctor.email }}</small>{% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                       <p class="text-muted">No doctors found associated with the '{{ details.condition.department_name or 'N/A' }}' department.</p>
                    {% endif %}
                </div>
            </div>

        </div> {# End vstack #}
    </div> {# End Right Column #}

</div>

{% endblock %}

{% block scripts %}
    {# Include Bootstrap JS for dismissible alerts and potentially modals #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    {# --- REMOVED ASSOCIATION MANAGEMENT JAVASCRIPT --- #}
    {# Keep deactivate confirmation if needed #}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const deactivateForm = document.getElementById('deactivate-form');
        if(deactivateForm) {
            deactivateForm.addEventListener('submit', function(event) {
                 // Use condition name from h1 tag if details object isn't directly available here
                 const conditionNameElement = document.querySelector('h1');
                 const conditionName = conditionNameElement ? conditionNameElement.textContent.replace('Condition: ', '').trim() : 'this condition';
                if (!confirm(`Are you sure you want to deactivate condition '${conditionName}'? This action sets it as inactive.`)) {
                    event.preventDefault();
                }
            });
        }
         // Keep flash message JS ONLY if other parts of the page might trigger AJAX flashes
        // function flashMessage(message, category = 'info', duration = 5000) { ... }
    });
    </script>

{% endblock %}