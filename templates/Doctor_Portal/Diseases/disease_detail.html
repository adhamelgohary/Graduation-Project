{# templates/Doctor_Portal/Diseases/disease_detail.html #}
{% extends "Doctor_Portal/base.html" %}

{% block title %}Condition Details: {{ details.condition.condition_name }}{% endblock %}

{% block head_extra %}
    <meta name="csrf-token" content="{{ csrf_token() if csrf_token else '' }}"> {# Add this if using CSRF #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/disease_catalog.css') }}">
    <style>
        .detail-section { margin-bottom: var(--spacing-lg); }
        .detail-label { font-weight: 600; color: var(--color-secondary); font-size: 0.9em; margin-bottom: 0.1rem; display: block;}
        .detail-value { margin-bottom: var(--spacing-md); color: var(--color-text); font-size: 1rem; }
        .detail-value p:last-child { margin-bottom: 0; } /* Remove extra margin if using paragraphs */
        .detail-value.pre-wrap { white-space: pre-wrap; word-wrap: break-word; } /* For textareas */
        .association-list { list-style: none; padding: 0; margin-top: var(--spacing-sm);}
        .association-item { background-color: #f9f9f9; border: 1px solid #eee; border-radius: var(--border-radius); padding: var(--spacing-sm) var(--spacing-md); margin-bottom: var(--spacing-sm); display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        .association-item strong { color: var(--color-primary); }
        .association-item small { color: var(--color-text-muted); margin-left: var(--spacing-md); }
        .add-association-form { margin-top: var(--spacing-md); border-top: 1px dashed var(--color-border); padding-top: var(--spacing-md);}
        .remove-association-btn { background: none; border: none; color: var(--color-danger); cursor: pointer; font-size: 1.1rem; padding: 0 5px; line-height: 1; opacity: 0.7; }
        .remove-association-btn:hover { opacity: 1; }
        .disease-image { max-width: 250px; max-height: 200px; object-fit: cover; border: 1px solid #ddd; padding: 3px; border-radius: var(--border-radius); margin-top: 5px;}
        .doctor-list li { margin-bottom: 0.5rem; }
        .flash-messages-container { position: fixed; top: 80px; right: 20px; z-index: 1050; width: 350px; }
        .flash-messages-container .alert { margin-bottom: 10px; }
    </style>
{% endblock %}

{% block content %}
{# Fixed container for flash messages generated by AJAX #}
<div class="flash-messages-container"></div>

<div class="page-header">
    <h1>Condition: {{ details.condition.condition_name }}</h1>
    <div>
        <a href="{{ url_for('disease_management.edit_disease', condition_id=details.condition.condition_id) }}" class="button button-outline button-secondary button-small">
            <i class="fas fa-edit fa-fw"></i> Edit
        </a>
        {# Deactivate Form - Needs JS confirmation #}
        <form id="deactivate-form" action="{{ url_for('disease_management.deactivate_disease', condition_id=details.condition.condition_id) }}" method="POST" class="d-inline">
             <button type="submit" class="button button-outline button-danger button-small" title="Deactivate Condition">
                 <i class="fas fa-times-circle fa-fw"></i> Deactivate
             </button>
         </form>
         <a href="{{ url_for('disease_management.list_diseases') }}" class="button button-outline button-secondary button-small ms-2">
            <i class="fas fa-arrow-left fa-fw"></i> Catalog
        </a>
    </div>
</div>

<div class="row gy-4">
    {# Left Column: Basic Info, Details, Image #}
    <div class="col-lg-7">
        <div class="card shadow-sm content-section h-100"> {# Added h-100 #}
             <div class="card-header"><h4><i class="fas fa-info-circle"></i> Condition Details</h4></div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <span class="detail-label">Condition Name</span>
                        <div class="detail-value"><strong>{{ details.condition.condition_name }}</strong></div>
                    </div>
                    <div class="col-md-4">
                        <span class="detail-label">ICD Code</span>
                        <div class="detail-value">{{ details.condition.icd_code | default('N/A') }}</div>
                    </div>
                </div>
                 <div class="mb-3"> {# Changed from form-group #}
                    <span class="detail-label">Description</span>
                    <div class="detail-value pre-wrap">{{ details.condition.description | default('No description provided.') }}</div>
                </div>
                 <hr>

                 <div class="row">
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Urgency</span> <div class="detail-value urgency-{{ details.condition.urgency_level | lower }}">{{ details.condition.urgency_level | title }}</div> </div>
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Type</span> <div class="detail-value">{{ details.condition.condition_type | title | default('-') }}</div> </div>
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Gender Relevance</span> <div class="detail-value">{{ details.condition.gender_relevance | title }}</div> </div>
                    <div class="col-md-3 col-6 mb-3"> <span class="detail-label">Self-Treatable</span> <div class="detail-value">{{ 'Yes' if details.condition.self_treatable else 'No' }}</div> </div>
                    <div class="col-md-4 col-6 mb-3"> <span class="detail-label">Age Relevance</span> <div class="detail-value">{{ details.condition.age_relevance | default('Any') }}</div> </div>
                    <div class="col-md-4 col-6 mb-3"> <span class="detail-label">Specialist</span> <div class="detail-value">{{ details.condition.specialist_type | default('N/A') }}</div> </div>
                    <div class="col-md-4 col-6 mb-3"> <span class="detail-label">Typical Duration</span> <div class="detail-value">{{ details.condition.typical_duration | default('Variable') }}</div> </div>
                 </div>
                 <hr>

                 {# New Text Fields #}
                 <div class="mb-3">
                    <span class="detail-label">Overview</span>
                    <div class="detail-value pre-wrap">{{ details.condition.overview | default('N/A') }}</div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Common Symptoms (Text)</span>
                    <div class="detail-value pre-wrap">{{ details.condition.symptoms_text | default('N/A') }}</div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Potential Causes (Text)</span>
                    <div class="detail-value pre-wrap">{{ details.condition.causes_text | default('N/A') }}</div>
                 </div>
                 <hr>

                 {# Testing & Diagnosis Info #}
                 <div class="row">
                     <div class="col-md-6 mb-3">
                         <span class="detail-label">Primary Testing Type</span>
                         <div class="detail-value">{{ details.condition.testing_type_name | default('N/A') }}</div>
                     </div>
                     <div class="col-md-6 mb-3">
                         <span class="detail-label">Primary Diagnosis Method</span>
                         <div class="detail-value">{{ details.condition.diagnosis_type_name | default('N/A') }}</div>
                     </div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Testing Details</span>
                    <div class="detail-value pre-wrap">{{ details.condition.testing_details | default('N/A') }}</div>
                 </div>
                 <div class="mb-3">
                    <span class="detail-label">Diagnosis Details</span>
                    <div class="detail-value pre-wrap">{{ details.condition.diagnosis_details | default('N/A') }}</div>
                 </div>
                 <hr>

                 {# Education & Image #}
                <div class="mb-3">
                     <span class="detail-label">Patient Education / Links</span>
                     {# urlize detects links, nl2br preserves newlines, use 'safe' ONLY if content is trusted HTML #}
                     <div class="detail-value pre-wrap">{{ details.condition.educational_content | default('None provided.') | urlize(40, true) }}</div>
                </div>

                 {% if details.condition.disease_image_filename %}
                 <div class="mb-3">
                    <span class="detail-label">Image</span><br>
                    <a href="{{ url_for('uploaded_disease_image', filename=details.condition.disease_image_filename) }}" target="_blank">
                       <img src="{{ url_for('uploaded_disease_image', filename=details.condition.disease_image_filename) }}" alt="{{ details.condition.condition_name }} Image" class="disease-image">
                    </a>
                 </div>
                 {% endif %}
            </div>
        </div>
    </div> {# End Left Column #}

    {# Right Column: Associations, Doctors #}
    <div class="col-lg-5">
        <div class="vstack gap-4"> {# Use vstack for vertical spacing #}

            {# Associated Symptoms #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-head-side-cough"></i> Associated Symptoms</h5></div>
                <div class="card-body">
                    <ul class="association-list" id="associated-symptoms-list">
                         {% include 'Doctor_Portal/Diseases/_association_list_items.html' with {'items': details.symptoms, 'id_field': 'symptom_id', 'name_field': 'symptom_name', 'type': 'symptom', 'details_template': '(W: %g, Req: %s)'} %}
                     </ul>
                     {% if not details.symptoms %}
                         <p class="text-muted no-associations">No symptoms linked yet.</p>
                     {% endif %}
                     <form class="add-association-form row g-2 align-items-end" id="add-symptom-form" data-type="symptom">
                         <div class="col">
                             <label for="add_symptom_id" class="form-label visually-hidden">Add Symptom</label>
                             {# Added inputs for weight and required #}
                             <div class="input-group input-group-sm">
                                 <select id="add_symptom_id" name="symptom_id" class="form-select" required>
                                     <option value="" selected disabled>-- Select Symptom --</option>
                                     {% for opt_sym in all_symptoms %}
                                     <option value="{{ opt_sym.symptom_id }}">{{ opt_sym.symptom_name }}</option>
                                     {% endfor %}
                                 </select>
                                 <input type="number" step="0.1" min="0" max="10" name="weight" class="form-control" placeholder="W (1.0)" style="max-width: 70px;">
                                 <div class="input-group-text">
                                    <input class="form-check-input mt-0" type="checkbox" value="true" name="is_required" title="Is Required?">
                                    <label class="ms-1 small" title="Is Required?">Req?</label>
                                 </div>
                             </div>
                         </div>
                         <div class="col-auto">
                              <button type="submit" class="button button-success button-small"><i class="fas fa-plus"></i> Link</button>
                         </div>
                     </form>
                </div>
            </div>

            {# Associated Risk Factors #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-exclamation-triangle"></i> Associated Risk Factors</h5></div>
                <div class="card-body">
                     <ul class="association-list" id="associated-risk_factors-list"> {# Note: type in ID #}
                        {% include 'Doctor_Portal/Diseases/_association_list_items.html' with {'items': details.risk_factors, 'id_field': 'factor_id', 'name_field': 'factor_name', 'type': 'risk_factor', 'details_template': '(Type: %s, W: %g)'} %}
                    </ul>
                    {% if not details.risk_factors %}
                         <p class="text-muted no-associations">No risk factors linked yet.</p>
                     {% endif %}
                    <form class="add-association-form row g-2 align-items-end" id="add-risk_factor-form" data-type="risk_factor"> {# Note: type in ID #}
                        <div class="col">
                            <label for="add_risk_factor_id" class="form-label visually-hidden">Add Risk Factor</label>
                            <div class="input-group input-group-sm">
                                <select id="add_risk_factor_id" name="factor_id" class="form-select" required>
                                    <option value="" selected disabled>-- Select Factor --</option>
                                    {% for opt_rf in all_risk_factors %}
                                    <option value="{{ opt_rf.factor_id }}">{{ opt_rf.factor_name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="number" step="0.1" min="0" max="10" name="weight" class="form-control" placeholder="W (1.0)" style="max-width: 70px;">
                            </div>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="button button-success button-small"><i class="fas fa-plus"></i> Link</button>
                        </div>
                    </form>
                </div>
            </div>

            {# Associated Protocols #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-clipboard-list"></i> Associated Treatment Protocols</h5></div>
                <div class="card-body">
                    <ul class="association-list" id="associated-protocols-list">
                        {% include 'Doctor_Portal/Diseases/_association_list_items.html' with {'items': details.protocols, 'id_field': 'protocol_id', 'name_field': 'protocol_name', 'type': 'protocol', 'details_template': '(Rel: %s)', 'link_field': 'guideline_url'} %}
                    </ul>
                    {% if not details.protocols %}
                         <p class="text-muted no-associations">No protocols linked yet.</p>
                     {% endif %}
                    <form class="add-association-form row g-2 align-items-end" id="add-protocol-form" data-type="protocol">
                       <div class="col">
                            <label for="add_protocol_id" class="form-label visually-hidden">Add Protocol</label>
                            <div class="input-group input-group-sm">
                                <select id="add_protocol_id" name="protocol_id" class="form-select" required>
                                    <option value="" selected disabled>-- Select Protocol --</option>
                                    {% for opt_pro in all_protocols %}
                                    <option value="{{ opt_pro.protocol_id }}">{{ opt_pro.protocol_name }}</option>
                                    {% endfor %}
                                </select>
                                {# Add relevance dropdown/input if needed #}
                                <select name="relevance" class="form-select" style="max-width: 120px;" title="Relevance">
                                     <option value="Recommended">Recommended</option>
                                     <option value="Consider">Consider</option>
                                     <option value="Optional">Optional</option>
                                     <option value="Investigational">Investigational</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="button button-success button-small"><i class="fas fa-plus"></i> Link</button>
                        </div>
                    </form>
                </div>
            </div>

             {# Associated Doctors #}
            <div class="card shadow-sm content-section">
                <div class="card-header"><h5><i class="fas fa-user-md"></i> Associated Doctors</h5></div>
                <div class="card-body">
                    <span class="detail-label">Department</span>
                    <div class="detail-value mb-3">{{ details.condition.department_name or 'N/A' }}</div>

                    {% if details.associated_doctors %}
                      <ul class="list-unstyled doctor-list">
                        {% for doctor in details.associated_doctors %}
                          <li>
                            <i class="fas fa-user-md fa-fw text-muted"></i>
                             {# Assume doctor profile link exists #}
                             {# <a href="{{ url_for('doctor_profile.view', user_id=doctor.user_id) }}"> #}
                                Dr. {{ doctor.first_name }} {{ doctor.last_name }}
                             {# </a> #}
                             {% if doctor.email %} <small class="text-muted"> - {{ doctor.email }}</small>{% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                       <p class="text-muted">No doctors found associated with the '{{ details.condition.department_name or 'N/A' }}' department.</p>
                    {% endif %}
                </div>
            </div>

        </div> {# End vstack #}
    </div> {# End Right Column #}

</div>


{% endblock %}

{% block scripts %}
    {# Include Bootstrap JS for dismissible alerts and potentially modals #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    {# New reusable template for list items #}
    <template id="association-item-template">
        <li class="association-item" id="link-{type}-{id}">
            <span>
                <strong>{name}</strong>
                <small> {details_html}</small>
                {link_html}
            </span>
            <button class="remove-association-btn" data-type="{type}" data-link-id="{id}" title="Remove Link">×</button>
        </li>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const conditionId = '{{ details.condition.condition_id }}';
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'); // For CSRF

        // --- Flash Message Function ---
        function flashMessage(message, category = 'info', duration = 5000) {
            const container = document.querySelector('.flash-messages-container');
            if (!container) { console.warn("Flash container not found for message:", message); return; }
            const alertDiv = document.createElement('div');
            // Map category for Bootstrap classes
            const alertClass = { info: 'info', success: 'success', warning: 'warning', danger: 'danger', error: 'danger'}[category] || 'info';
            alertDiv.className = `alert alert-${alertClass} alert-dismissible fade`; // Start faded out
            alertDiv.setAttribute('role', 'alert');
            alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            container.insertBefore(alertDiv, container.firstChild);
            // Trigger fade in
            setTimeout(() => alertDiv.classList.add('show'), 50);
            // Set timeout to fade out and remove
            if (duration > 0) {
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    // Wait for fade out transition before removing
                    alertDiv.addEventListener('transitionend', () => alertDiv.remove(), { once: true });
                }, duration);
            }
        }

        // --- Handle Deactivate Confirmation ---
        const deactivateForm = document.getElementById('deactivate-form');
        if(deactivateForm) {
            deactivateForm.addEventListener('submit', function(event) {
                if (!confirm('Are you sure you want to deactivate condition \'{{ details.condition.condition_name|escape|e }}\'? This action sets it as inactive.')) {
                    event.preventDefault();
                }
            });
        }

        // --- Generic AJAX Function ---
        async function sendAjaxRequest(url, method, data = null) {
            const headers = {
                'Accept': 'application/json',
            };
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken; // Add CSRF token if available
            }

            const options = {
                method: method,
                headers: headers,
            };

            if (data && (method === 'POST' || method === 'PUT')) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                const result = await response.json(); // Assume server always returns JSON
                return { ok: response.ok, status: response.status, data: result };
            } catch (error) {
                console.error(`AJAX Error (${method} ${url}):`, error);
                return { ok: false, status: 500, data: { success: false, message: 'Network or client-side error occurred.' } };
            }
        }

       // --- Template Rendering Function ---
        function renderAssociationItem(templateId, data) {
            const template = document.getElementById(templateId);
            if (!template) return '';
            let html = template.innerHTML;
            for (const key in data) {
                html = html.replace(new RegExp(`{${key}}`, 'g'), data[key]);
            }
            return html;
        }

        // --- Format Details String based on type ---
        function formatItemDetails(type, itemData) {
             let details = '';
             let linkHtml = '';
             if (type === 'symptom') {
                 details = `(W: ${itemData.weight || 1.0}, Req: ${itemData.is_required ? 'Yes' : 'No'})`;
             } else if (type === 'risk_factor') {
                 details = `(Type: ${itemData.type || 'N/A'}, W: ${itemData.weight || 1.0})`;
             } else if (type === 'protocol') {
                 details = `(Rel: ${itemData.relevance || 'N/A'})`;
                 if (itemData.guideline_url) {
                     linkHtml = `<a href="${itemData.guideline_url}" target="_blank" title="View Guideline" class="ms-2"><i class="fas fa-external-link-alt"></i></a>`;
                 }
             }
             return { details_html: details, link_html: linkHtml};
        }


        // --- Handle ADD Association ---
        async function handleAddAssociation(event) {
            event.preventDefault();
            const form = event.target;
            const type = form.dataset.type; // e.g., 'symptom', 'risk_factor', 'protocol'
            const selectElement = form.querySelector('select[name$="_id"]'); // Selects the primary ID dropdown
            const linkId = selectElement?.value;

            if (!linkId) {
                flashMessage(`Please select a ${type.replace('_', ' ')} to link.`, 'warning');
                return;
            }

            // Collect data from form (handles different input names)
            const formData = new FormData(form);
            const postData = {};
            // Map form names to expected backend keys
            const keyMap = {
                'symptom_id': 'symptom_id',
                'factor_id': 'factor_id', // Map risk_factor select name
                'protocol_id': 'protocol_id',
                 // Add other fields if they exist in the form
                'weight': 'weight',
                'is_required': 'is_required',
                'relevance': 'relevance'
            };
            formData.forEach((value, key) => {
                if (keyMap[key]) {
                    // Convert checkbox 'true'/'on' to boolean true
                    postData[keyMap[key]] = (form.querySelector(`[name="${key}"]`)?.type === 'checkbox') ? (value === 'true' || value === 'on') : value;
                } else if (key === 'risk_factor_id') { // Specific handling if name is risk_factor_id
                     postData['factor_id'] = value;
                }
            });
            // Ensure the main ID is present even if select name was different
            if (type === 'symptom' && !postData.symptom_id) postData.symptom_id = linkId;
            if (type === 'risk_factor' && !postData.factor_id) postData.factor_id = linkId;
            if (type === 'protocol' && !postData.protocol_id) postData.protocol_id = linkId;


            const endpoint = `/doctor/diseases/${conditionId}/${type}s`; // Pluralize type for endpoint

            const { ok, status, data } = await sendAjaxRequest(endpoint, 'POST', postData);

            if (ok && data.success) {
                flashMessage(data.message || 'Link added successfully.', 'success');
                // Update UI Dynamically
                const listElement = document.getElementById(`associated-${type}s-list`); // Use plural type
                 const noItemsP = listElement.querySelector('.no-associations');
                 if (noItemsP) noItemsP.remove(); // Remove "no items" message

                const itemData = data.linked_item; // Assumes backend returns linked_item details
                 const { details_html, link_html } = formatItemDetails(type, itemData);

                const newItemHtml = renderAssociationItem('association-item-template', {
                    type: type,
                    id: itemData.id,
                    name: itemData.name,
                    details_html: details_html,
                    link_html: link_html
                });

                listElement.insertAdjacentHTML('beforeend', newItemHtml);
                form.reset(); // Reset the form
            } else {
                flashMessage(data.message || `Error linking ${type}. Status: ${status}`, 'danger');
            }
        }

        // --- Handle REMOVE Association ---
        async function handleRemoveAssociation(event) {
            const button = event.target.closest('.remove-association-btn');
            if (!button) return;

            event.preventDefault();
            const type = button.dataset.type;
            const linkId = button.dataset.linkId;
            const listItem = button.closest('.association-item');
            const itemName = listItem ? listItem.querySelector('strong')?.textContent : 'this item';

            if (!type || !linkId) return;

            if (confirm(`Are you sure you want to remove the link for "${itemName}"?`)) {
                const endpoint = `/doctor/diseases/${conditionId}/${type}s/${linkId}`; // Pluralize type

                const { ok, status, data } = await sendAjaxRequest(endpoint, 'DELETE');

                if (ok && data.success) {
                    flashMessage(data.message || 'Link removed successfully.', 'success');
                    // Remove the item from the list
                    if (listItem) {
                        listItem.style.transition = 'opacity 0.3s ease-out';
                        listItem.style.opacity = '0';
                        setTimeout(() => {
                            listItem.remove();
                             // Check if list is now empty
                            const listElement = document.getElementById(`associated-${type}s-list`);
                            if (listElement && !listElement.querySelector('.association-item')) {
                                listElement.innerHTML = '<p class="text-muted no-associations">No items linked yet.</p>';
                            }
                        }, 300); // Wait for fade before removing
                    }
                } else {
                    flashMessage(data.message || `Error removing link. Status: ${status}`, 'danger');
                }
            }
        }

        // --- Attach Event Listeners ---
        const addForms = document.querySelectorAll('.add-association-form');
        addForms.forEach(form => form.addEventListener('submit', handleAddAssociation));

        // Use event delegation for remove buttons
        const contentArea = document.querySelector('.content'); // Adjust selector if needed
        if (contentArea) {
            contentArea.addEventListener('click', handleRemoveAssociation);
        } else {
            // Fallback if .content isn't the main container
            document.body.addEventListener('click', handleRemoveAssociation);
        }

    });
    </script>

    {# Include a reusable template for list items (Optional but cleaner) #}
    {# You would create this file: templates/Doctor_Portal/Diseases/_association_list_items.html #}
    {# {% include 'Doctor_Portal/Diseases/_association_list_items.html' with {'items': details.symptoms, 'id_field': 'symptom_id', 'name_field': 'symptom_name', 'type': 'symptom', 'details_template': '(W: %g, Req: %s)'} %} #}

{% endblock %}