{# templates/Doctor_Portal/Diseases/disease_form.html #}
{% extends "Doctor_Portal/base.html" %}

{% block title %}{{ form_title | default('Manage Disease/Condition') }}{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/disease_catalog.css') }}">
    <style>
        .form-section h4 {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-primary);
        }
        .form-section { margin-bottom: 1.5rem; }
        .form-actions { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--color-border); text-align: right; }
        .current-image-display img { border: 1px solid #ddd; padding: 2px; margin-bottom: 5px;}
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ form_title | default('Manage Disease/Condition') }}</h1>
    <a href="{{ url_for('disease_management.list_diseases') }}" class="button button-outline button-secondary">
        <i class="fas fa-arrow-left fa-fw"></i> Back to Catalog
    </a>
</div>

{# --- Display ALL Flash Messages --- #}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages-inline mb-4">
            {% for category, message in messages %}
                <div class="alert alert-{{ category|replace('danger', 'error')|replace('warning', 'warning')|replace('success', 'success')|default('info') }} alert-dismissible fade show" role="alert"> {# Adjusted categories slightly for styling #}
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{# --- Display Specific Validation Errors --- #}
{% if errors and request.method == 'POST' %}
<div class="alert alert-error alert-dismissible fade show mb-4" role="alert"> {# Use alert-error #}
    <strong>Please correct the following errors:</strong>
    <ul> {% for error in errors %} <li>{{ error }}</li> {% endfor %} </ul>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
{# --- End Errors --- #}


<div class="card shadow-sm disease-form content-section">
    <div class="card-body">
        {# IMPORTANT: Added enctype for file uploads #}
        <form action="{{ form_action }}" method="POST" class="data-form" enctype="multipart/form-data">
             {# CSRF Token if using Flask-WTF #}
             {# {{ form.csrf_token }} #}

            <div class="form-section">
                <h4><i class="fas fa-notes-medical fa-fw"></i> Basic Information</h4>
                <div class="row">
                    <div class="col-md-8 form-group mb-3"> {# Added mb-3 #}
                        <label for="condition_name" class="form-label">Condition Name <span class="text-danger">*</span></label>
                        <input type="text" id="condition_name" name="condition_name" class="form-control" value="{{ disease.condition_name if disease else request.form.get('condition_name', '') }}" required>
                    </div>
                     <div class="col-md-4 form-group mb-3"> {# Added mb-3 #}
                        <label for="icd_code" class="form-label">ICD Code</label>
                        <input type="text" id="icd_code" name="icd_code" class="form-control" value="{{ disease.icd_code if disease else request.form.get('icd_code', '') }}" placeholder="e.g., I10">
                    </div>
                </div>
                <div class="form-group mb-3"> {# Added mb-3 #}
                    <label for="description" class="form-label">Brief Description</label>
                    <textarea id="description" name="description" class="form-control" rows="3">{{ disease.description if disease else request.form.get('description', '') }}</textarea>
                </div>
            </div>

             <div class="form-section">
                <h4><i class="fas fa-tags fa-fw"></i> Classification & Relevance</h4>
                <div class="row">
                    <div class="col-md-3 form-group mb-3"> {# Adjusted col size #}
                        <label for="urgency_level" class="form-label">Urgency Level <span class="text-danger">*</span></label>
                        <select id="urgency_level" name="urgency_level" class="form-select" required>
                            <option value="" disabled {% if not (disease.urgency_level if disease else request.form.get('urgency_level')) %}selected{% endif %}>-- Select --</option>
                            {% set selected_urgency = (disease.urgency_level if disease else request.form.get('urgency_level')) | string %}
                            {% for level in urgency_levels %}
                                <option value="{{ level }}" {% if selected_urgency == level %}selected{% endif %}>{{ level | title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                     <div class="col-md-3 form-group mb-3"> {# Adjusted col size #}
                        <label for="condition_type" class="form-label">Condition Type</label>
                        <select id="condition_type" name="condition_type" class="form-select">
                             <option value="" {% if not (disease.condition_type if disease else request.form.get('condition_type')) %}selected{% endif %}>-- Optional --</option>
                              {% set selected_type = (disease.condition_type if disease else request.form.get('condition_type')) | string %}
                             {% for type_val in condition_types %}
                                 <option value="{{ type_val }}" {% if selected_type == type_val %}selected{% endif %}>{{ type_val | title }}</option>
                             {% endfor %}
                        </select>
                    </div>
                     <div class="col-md-3 form-group mb-3"> {# Adjusted col size #}
                         <label for="gender_relevance" class="form-label">Gender Relevance <span class="text-danger">*</span></label>
                        <select id="gender_relevance" name="gender_relevance" class="form-select" required>
                            {% set selected_gender = (disease.gender_relevance if disease else request.form.get('gender_relevance', 'all')) | string %}
                            {% for relevance in gender_relevance_opts %}
                                <option value="{{ relevance }}" {% if selected_gender == relevance %}selected{% endif %}>{{ relevance | title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                     <div class="col-md-3 form-group mb-3"> {# Adjusted col size #}
                        <label for="department_id" class="form-label">Department</label> {# Made optional, adjust if needed #}
                        <select id="department_id" name="department_id" class="form-select">
                             <option value="" {% if not (disease.department_id if disease else request.form.get('department_id')) %}selected{% endif %}>-- Optional --</option>
                              {% set selected_dept_id = (disease.department_id if disease else request.form.get('department_id')) | string %}
                             {% for dept in departments %}
                                 <option value="{{ dept.department_id }}" {% if selected_dept_id == dept.department_id|string %}selected{% endif %}>{{ dept.name }}</option>
                             {% endfor %}
                        </select>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6 form-group mb-3">
                        <label for="age_relevance" class="form-label">Age Relevance</label>
                        <input type="text" id="age_relevance" name="age_relevance" class="form-control" value="{{ disease.age_relevance if disease else request.form.get('age_relevance', '') }}" placeholder="e.g., adults, children">
                        <small class="text-muted">Comma-separated terms</small>
                    </div>
                    <div class="col-md-6 form-group mb-3">
                        <label for="specialist_type" class="form-label">Relevant Specialist</label>
                        <input type="text" id="specialist_type" name="specialist_type" class="form-control" value="{{ disease.specialist_type if disease else request.form.get('specialist_type', '') }}" placeholder="e.g., Cardiologist">
                    </div>
                 </div>
            </div>


            <div class="form-section">
                <h4><i class="fas fa-file-medical-alt fa-fw"></i> Detailed Information</h4>
                 <div class="form-group mb-3">
                    <label for="overview" class="form-label">Overview</label>
                    <textarea id="overview" name="overview" class="form-control" rows="4" placeholder="Detailed overview of the condition.">{{ disease.overview if disease else request.form.get('overview', '') }}</textarea>
                </div>
                 <div class="form-group mb-3">
                    <label for="symptoms_text" class="form-label">Common Symptoms (Text)</label>
                    <textarea id="symptoms_text" name="symptoms_text" class="form-control" rows="4" placeholder="Describe common symptoms in text format (supplements linked symptoms).">{{ disease.symptoms_text if disease else request.form.get('symptoms_text', '') }}</textarea>
                </div>
                 <div class="form-group mb-3">
                    <label for="causes_text" class="form-label">Potential Causes (Text)</label>
                    <textarea id="causes_text" name="causes_text" class="form-control" rows="4" placeholder="Describe potential causes or etiology.">{{ disease.causes_text if disease else request.form.get('causes_text', '') }}</textarea>
                </div>
            </div>

            <div class="form-section">
                <h4><i class="fas fa-vials fa-fw"></i> Testing & Diagnosis</h4>
                <div class="row">
                     <div class="col-md-6 form-group mb-3">
                        <label for="testing_type_id" class="form-label">Primary Testing Type</label>
                        <select id="testing_type_id" name="testing_type_id" class="form-select">
                             <option value="" {% if not (disease.testing_type_id if disease else request.form.get('testing_type_id')) %}selected{% endif %}>-- Optional --</option>
                              {% set selected_test_id = (disease.testing_type_id if disease else request.form.get('testing_type_id')) | string %}
                             {% for ttype in testing_types %}
                                 <option value="{{ ttype.testing_type_id }}" {% if selected_test_id == ttype.testing_type_id|string %}selected{% endif %}>{{ ttype.name }}</option>
                             {% endfor %}
                        </select>
                    </div>
                     <div class="col-md-6 form-group mb-3">
                        <label for="diagnosis_type_id" class="form-label">Primary Diagnosis Method</label>
                        <select id="diagnosis_type_id" name="diagnosis_type_id" class="form-select">
                             <option value="" {% if not (disease.diagnosis_type_id if disease else request.form.get('diagnosis_type_id')) %}selected{% endif %}>-- Optional --</option>
                              {% set selected_diag_id = (disease.diagnosis_type_id if disease else request.form.get('diagnosis_type_id')) | string %}
                             {% for dtype in diagnosis_types %}
                                 <option value="{{ dtype.diagnosis_type_id }}" {% if selected_diag_id == dtype.diagnosis_type_id|string %}selected{% endif %}>{{ dtype.name }}</option>
                             {% endfor %}
                        </select>
                    </div>
                </div>
                 <div class="form-group mb-3">
                    <label for="testing_details" class="form-label">Testing Details</label>
                    <textarea id="testing_details" name="testing_details" class="form-control" rows="3" placeholder="Describe common tests used.">{{ disease.testing_details if disease else request.form.get('testing_details', '') }}</textarea>
                </div>
                 <div class="form-group mb-3">
                    <label for="diagnosis_details" class="form-label">Diagnosis Details</label>
                    <textarea id="diagnosis_details" name="diagnosis_details" class="form-control" rows="3" placeholder="Describe how the diagnosis is typically confirmed.">{{ disease.diagnosis_details if disease else request.form.get('diagnosis_details', '') }}</textarea>
                </div>
            </div>

             <div class="form-section">
                <h4><i class="fas fa-tasks fa-fw"></i> Management & Education</h4>
                 <div class="row">
                     <div class="col-md-6 form-group mb-3">
                        <label for="typical_duration" class="form-label">Typical Duration</label>
                        <input type="text" id="typical_duration" name="typical_duration" class="form-control" value="{{ disease.typical_duration if disease else request.form.get('typical_duration', '') }}" placeholder="e.g., 1-2 weeks, lifelong">
                     </div>
                     <div class="col-md-6 form-group d-flex align-items-center pt-3 mb-3">
                        <div class="form-check form-switch">
                            {# Check disease object first, then fallback to request.form #}
                            {% set is_treatable = (disease and disease.self_treatable == 1) or request.form.get('self_treatable') == 'on' %}
                            <input class="form-check-input" type="checkbox" role="switch" id="self_treatable" name="self_treatable" {% if is_treatable %}checked{% endif %}>
                            <label class="form-check-label" for="self_treatable">Potentially Self-Treatable</label>
                        </div>
                    </div>
                </div>
                 <div class="form-group mb-3">
                    <label for="educational_content" class="form-label">Patient Education Content / Links</label>
                    <textarea id="educational_content" name="educational_content" class="form-control" rows="4" placeholder="Provide links or summary information for patients/doctors.">{{ disease.educational_content if disease else request.form.get('educational_content', '') }}</textarea>
                </div>
            </div>

            <div class="form-section">
                 <h4><i class="fas fa-image fa-fw"></i> Image</h4>
                 {# --- Image Upload Section --- #}
                 {% if disease and disease.disease_image_filename %}
                 <div class="mb-3 current-image-display">
                         <label>Current Image:</label><br>
                         <img src="{{ url_for('uploaded_disease_image', filename=disease.disease_image_filename) }}" alt="Current Disease Image" style="max-width: 200px; max-height: 150px; object-fit: cover;">
                         <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="delete_image" id="delete_image" value="on">
                            <label class="form-check-label" for="delete_image">Delete current image when saving</label>
                         </div>
                         {# Hidden field to track the current image file name #}
                         <input type="hidden" name="current_disease_image_filename" value="{{ disease.disease_image_filename }}">
                 </div>
                 {% endif %}
                 <div class="form-group mb-3">
                     <label for="disease_image" class="form-label">{% if disease and disease.disease_image_filename %}Replace Image{% else %}Upload Image{% endif %} (Optional)</label>
                     <input class="form-control" type="file" id="disease_image" name="disease_image" accept="image/png, image/jpeg, image/gif, image/webp">
                     <small class="text-muted">Allowed types: PNG, JPG, GIF, WEBP. Max size: {{ config.MAX_CONTENT_LENGTH | filesizeformat }}.</small>
                 </div>
            </div>

            {# --- Form Actions --- #}
            <div class="form-actions">
                <a href="{{ url_for('disease_management.list_diseases') }}" class="button button-outline button-secondary">Cancel</a>
                <button type="submit" class="button button-primary">
                    <i class="fas fa-save fa-fw"></i> {{ 'Update Condition' if disease else 'Add Condition' }}
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
{# Include Bootstrap JS if needed for dismissible alerts #}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
{% endblock %}