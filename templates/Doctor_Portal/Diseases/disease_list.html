{# templates/Doctor_Portal/Diseases/disease_list.html #}
{% extends "Doctor_Portal/base.html" %}

{% block title %}Disease Catalog{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='Doctor_Portal/disease_catalog.css') }}">
    <style>
        .filter-form .form-select-sm { height: calc(1.5em + 0.5rem + 2px); }
        .urgency-low { color: var(--color-success); }
        .urgency-medium { color: #fd7e14; } /* Bootstrap Orange */
        .urgency-high { color: var(--color-danger); }
        .urgency-emergency { color: var(--color-danger); font-weight: bold; background-color: #f8d7da; padding: 0.1em 0.3em; border-radius: 3px;}
        th a { color: inherit; text-decoration: none; }
        th a:hover { color: var(--color-primary); }
        th .sort-icon { opacity: 0.4; font-size: 0.8em; margin-left: 5px; }
        th .sort-icon.active { opacity: 1; color: var(--color-primary); }
        .table th, .table td { vertical-align: middle; } /* Align content vertically */
        .department-filter-info { font-style: italic; color: var(--color-text-muted); } /* Styling for department info */
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Disease / Condition Catalog</h1>
    <a href="{{ url_for('disease_management.add_disease') }}" class="button button-primary"> <i class="fas fa-plus fa-fw"></i> Add New Condition </a>
</div>

{# --- Display Department Filter Information --- #}
<p class="department-filter-info mb-3">
    <i class="fas fa-filter fa-fw"></i>
    Showing conditions associated with the <strong>'{{ doctor_department_name | default('All') }}'</strong> Department.
</p>

{# --- Search & Filter Form (Department Filter Removed) --- #}
<form method="GET" action="{{ url_for('disease_management.list_diseases') }}" class="search-form card card-body mb-4">
    <div class="row g-3 align-items-end">
        {# Search Input #}
        <div class="col-lg-4 col-md-12">
            <label for="search" class="form-label visually-hidden">Search</label>
            <div class="input-group">
                 <span class="input-group-text"><i class="fas fa-search fa-fw"></i></span>
                <input type="search" class="form-control" id="search" name="search" placeholder="Search Name, Desc, Code..." value="{{ search_term | default('') }}">
            </div>
        </div>
        {# Urgency Filter #}
        <div class="col-lg col-md-4 col-sm-6"> {# Adjusted col size #}
             <label for="filter_urgency" class="form-label">Urgency</label>
            <select id="filter_urgency" name="filter_urgency" class="form-select form-select-sm">
                 <option value="" {% if not filters.urgency %}selected{% endif %}>Any Urgency</option>
                 {% for level in urgency_levels %}
                    <option value="{{ level }}" {% if filters.urgency == level %}selected{% endif %}>{{ level | title }}</option>
                 {% endfor %}
            </select>
        </div>
        {# Type Filter #}
        <div class="col-lg col-md-4 col-sm-6"> {# Adjusted col size #}
            <label for="filter_type" class="form-label">Type</label>
             <select id="filter_type" name="filter_type" class="form-select form-select-sm">
                 <option value="" {% if not filters.type %}selected{% endif %}>Any Type</option>
                  {% for type_val in condition_types %}
                    <option value="{{ type_val }}" {% if filters.type == type_val %}selected{% endif %}>{{ type_val | title }}</option>
                 {% endfor %}
            </select>
        </div>
        {# --- REMOVED Department Filter Dropdown --- #}
        {# Action Buttons #}
        <div class="col-lg-auto col-md-4 col-sm-12 d-flex justify-content-end gap-2 flex-wrap"> {# Adjusted col size #}
             {# Check remaining filters #}
             {% if search_term or filters.urgency or filters.type or filters.testing_type_id or filters.diagnosis_type_id %}
                 <a href="{{ url_for('disease_management.list_diseases') }}" class="button button-outline button-secondary button-small mt-3">Clear Filters</a>
             {% endif %}
             <button type="submit" class="button button-primary button-small mt-3">Apply Filters</button>
        </div>
    </div>
     {# Hidden inputs for sorting persistence (Remove department filter) #}
     <input type="hidden" name="sort_by" value="{{ sort_by | default('name') }}">
     <input type="hidden" name="sort_dir" value="{{ sort_dir | default('ASC') }}">
</form>

{# --- Disease Table --- #}
<div class="card shadow-sm disease-list-card">
    <div class="card-body p-0">
        {% if diseases %}
        <div class="table-responsive">
            <table class="table table-striped table-hover disease-list-table mb-0">
                <thead>
                    <tr>
                        {# Sorting Links - pass current filters along (excluding department) #}
                        {% macro sort_link(col_key, col_title) %}
                            {% set current_dir = 'ASC' if sort_by != col_key else ('DESC' if sort_dir == 'ASC' else 'ASC') %}
                            {# Base args for sorting links - EXCLUDE department filter #}
                            {% set base_args_sort = {'page': 1, 'search': search_term, 'filter_urgency': filters.urgency, 'filter_type': filters.type, 'filter_testing_type': filters.testing_type_id, 'filter_diagnosis_type': filters.diagnosis_type_id} %}
                            <a href="{{ url_for('disease_management.list_diseases', sort_by=col_key, sort_dir=current_dir, **base_args_sort) }}" title="Sort by {{ col_title }}">
                                {{ col_title }}
                                {% if sort_by == col_key %}
                                    <i class="fas {{ 'fa-sort-up' if sort_dir == 'ASC' else 'fa-sort-down' }} sort-icon active"></i>
                                {% else %}
                                    <i class="fas fa-sort sort-icon"></i>
                                {% endif %}
                            </a>
                        {% endmacro %}
                        <th style="width: 5%;">{{ sort_link('id', 'ID') }}</th>
                        <th style="width: 25%;">{{ sort_link('name', 'Condition Name') }}</th>
                        <th style="width: 10%;">{{ sort_link('code', 'ICD Code') }}</th>
                        <th style="width: 12%;">{{ sort_link('type', 'Type') }}</th>
                        <th style="width: 12%;">{{ sort_link('urgency', 'Urgency') }}</th>
                        {# Display Department Column (read-only now) #}
                        <th style="width: 15%;">{{ sort_link('dept', 'Department') }}</th>
                        <th class="text-end" style="width: 21%;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for disease in diseases %}
                    <tr>
                        <td>{{ disease.condition_id }}</td>
                        <td>
                            <a href="{{ url_for('disease_management.view_disease', condition_id=disease.condition_id) }}" title="View Details">
                                <strong>{{ disease.condition_name }}</strong>
                            </a>
                        </td>
                        <td>{{ disease.icd_code | default('-') }}</td>
                        <td>{{ disease.condition_type | title | default('-') }}</td>
                        <td>{# Visual Cue for Urgency #}
                           <span class="urgency-{{ disease.urgency_level | lower }}">{{ disease.urgency_level | title | default('-') }}</span>
                        </td>
                        {# Display Department #}
                        <td>{{ disease.department_name | default('-') }}</td>
                        <td class="action-buttons text-end"> {# Align buttons to the right #}
                            <a href="{{ url_for('disease_management.view_disease', condition_id=disease.condition_id) }}" class="button button-outline button-small" title="View Details"><i class="fas fa-eye fa-fw"></i> <span class="d-none d-lg-inline">View</span></a> {# Adjust d-lg-inline if needed #}
                            <a href="{{ url_for('disease_management.edit_disease', condition_id=disease.condition_id) }}" class="button button-outline button-secondary button-small" title="Edit Condition"><i class="fas fa-edit fa-fw"></i> <span class="d-none d-lg-inline">Edit</span></a>
                            {# Deactivate Form - Uses POST #}
                            <form action="{{ url_for('disease_management.deactivate_disease', condition_id=disease.condition_id) }}" method="POST" class="d-inline" onsubmit="return confirm('Deactivate condition \'{{ disease.condition_name|escape }}\'?');">
                                {# CSRF token if needed #}
                                <button type="submit" class="button button-outline button-danger button-small" title="Deactivate Condition">
                                    <i class="fas fa-times-circle fa-fw"></i> <span class="d-none d-lg-inline">Deactivate</span>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# Pagination Controls (Remove department filter from base_args) #}
        {% if total_pages > 1 %}
        <div class="card-footer d-flex justify-content-center">
             <nav aria-label="Disease list navigation">
                <ul class="pagination pagination-sm mb-0">
                     {# Base args for pagination links - EXCLUDE department filter #}
                    {% set base_args_page = {'search': search_term, 'sort_by': sort_by, 'sort_dir': sort_dir, 'filter_urgency': filters.urgency, 'filter_type': filters.type, 'filter_testing_type': filters.testing_type_id, 'filter_diagnosis_type': filters.diagnosis_type_id} %}
                     {# Previous Page Link #}
                     <li class="page-item {{ 'disabled' if current_page <= 1 else '' }}">
                        <a class="page-link" href="{{ url_for('disease_management.list_diseases', page=current_page-1, **base_args_page) }}">« Prev</a>
                    </li>
                     {# Page Number Links (dynamic generation - unchanged logic) #}
                     {% set max_links = 5 %}{% set start_page = [1, current_page - (max_links // 2)] | max %}{% set end_page = [total_pages, start_page + max_links - 1] | min %}
                     {% if start_page > 1 %}<li class="page-item"><a class="page-link" href="{{ url_for('disease_management.list_diseases', page=1, **base_args_page) }}">1</a></li>{% if start_page > 2 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}{% endif %}
                     {% for page_num in range(start_page, end_page + 1) %}<li class="page-item {{ 'active' if page_num == current_page else '' }}"><a class="page-link" href="{{ url_for('disease_management.list_diseases', page=page_num, **base_args_page) }}">{{ page_num }}</a></li>{% endfor %}
                     {% if end_page < total_pages %}{% if end_page < total_pages - 1 %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}<li class="page-item"><a class="page-link" href="{{ url_for('disease_management.list_diseases', page=total_pages, **base_args_page) }}">{{ total_pages }}</a></li>{% endif %}
                     {# Next Page Link #}
                    <li class="page-item {{ 'disabled' if current_page >= total_pages else '' }}">
                        <a class="page-link" href="{{ url_for('disease_management.list_diseases', page=current_page+1, **base_args_page) }}">Next »</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}

        {% elif not diseases %} {# Handle case where no diseases match the department + filters #}
            <div class="no-results-message p-4 text-center"> {# Added padding/alignment #}
                 <i class="fas fa-book-medical fa-3x mb-3 text-muted"></i><br>
                 {# Updated message check to see if *any* filters were applied #}
                {% set has_filters = search_term or filters.urgency or filters.type or filters.testing_type_id or filters.diagnosis_type_id %}
                {% if has_filters %}
                    No conditions found in the '{{ doctor_department_name | default('assigned') }}' department matching your current filters. <a href="{{ url_for('disease_management.list_diseases') }}">Clear filters?</a>
                {% else %}
                    No conditions found associated with the '{{ doctor_department_name | default('assigned') }}' department. {% if current_user and current_user.user_type == 'admin' %} <a href="{{ url_for('disease_management.add_disease') }}">Add a condition?</a> {% endif %} {# Allow Admin to add #}
                {% endif %}
            </div>
        {% endif %}
    </div>{# end card-body #}
</div>
{% endblock %}