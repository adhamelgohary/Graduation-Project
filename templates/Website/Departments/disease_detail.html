{# templates/Website/Departments/disease_detail.html #}
{% extends "Website/base.html" %}

{% block title %}{{ condition.name | default('Condition Information') }}{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename=condition.specific_css | default('website/generic_disease.css')) }}">
  <style>
    /* Keep association-list for risk factors & protocols */
    .association-list {
        list-style: disc; /* Standard bullet points */
        padding-left: 25px;
        margin-top: 0.5rem;
        margin-bottom: 1rem; /* Add bottom margin */
    }
    .association-list li {
        margin-bottom: 0.5rem; /* Increase spacing slightly */
    }
    /* --- NEW/MODIFIED: Vertical Symptom List Styling --- */
    .symptom-list-vertical { /* New class for vertical list */
        list-style: disc; /* Use bullets */
        padding-left: 25px; /* Indentation */
        margin: 0.5rem 0 1rem 0;
    }
    .symptom-list-vertical li {
        margin-bottom: 0.4rem;
        /* Remove background/border/padding from inline style */
    }
    /* --- End Symptom List Styling --- */

    .protocol-link { margin-left: 8px; font-size: 0.9em; }
    hr.section-divider { margin: 1.5rem 0; border-top: 1px dashed var(--border-color-light, #ddd); }
    /* ... Keep other existing styles ... */
  </style>
{% endblock %}

{% block content %}
<div class="disease-container">
    <div class="header">
        <h1>{{ condition.name | default('Condition Details') }}</h1>
    </div>

    <div class="top-content">
        <div class="centered-gif">
            <img src="{{ condition.image_url | default(url_for('static', filename='images/conditions/disease_placeholder.png')) }}" alt="{{ condition.name | default('Condition') }}">
        </div>
        <div class="overview-container">
            <h2><i class="fas fa-info-circle"></i> Overview</h2>
            {% if condition.description and condition.description != condition.overview %}
                <p class="description-emphasis">{{ condition.description | safe }}</p>
                <hr>
            {% endif %}
            <div>
                {{ condition.overview | default('No overview available.') | safe }}
            </div>
        </div>
    </div>

    <div class="main-content">
        {# Quick Facts Card #}
        <div class="card quick-facts-card">
            <h3><i class="fas fa-list-check"></i> Quick Facts</h3>
            <dl class="quick-facts-list">
                {% if condition.condition_type %}<dt><i class="fas fa-tag fa-fw"></i>Type:</dt> <dd>{{ condition.condition_type | title }}</dd>{% endif %}
                {% if condition.urgency_level %}<dt><i class="fas fa-exclamation-circle fa-fw"></i>Urgency:</dt> <dd>{{ condition.urgency_level | title }}</dd>{% endif %}
                {% if condition.typical_duration %}<dt><i class="far fa-clock fa-fw"></i>Duration:</dt> <dd>{{ condition.typical_duration | escape }}</dd>{% endif %}
                {% if condition.icd_code %}<dt><i class="fas fa-barcode fa-fw"></i>ICD-10:</dt> <dd>{{ condition.icd_code | escape }}</dd>{% endif %}
                {% if condition.specialist_type %}<dt><i class="fas fa-user-md fa-fw"></i>Specialist:</dt> <dd>{{ condition.specialist_type | escape }}</dd>{% endif %}
                {% if condition.self_treatable_display %}<dt><i class="fas fa-notes-medical fa-fw"></i>Self-Treatable:</dt> <dd>{{ condition.self_treatable_display }}</dd>{% endif %}
            </dl>
        </div>

        {# --- Symptoms Section (MODIFIED List Structure) --- #}
        {% if symptoms or condition.symptoms_text %}
        <div class="card">
            <h3><i class="fas fa-head-side-cough"></i> Symptoms</h3>
            {# Display associated symptoms list FIRST if available #}
            {% if symptoms %}
                <p><strong>Key Symptoms Can Include:</strong></p>
                {# Changed class from symptom-list-inline to symptom-list-vertical #}
                <ul class="symptom-list-vertical">
                    {% for sym in symptoms %}
                        <li>{{ sym.symptom_name | escape }}</li>
                    {% endfor %}
                </ul>
            {% endif %}

            {# Display the text description of symptoms #}
            {% if condition.symptoms_text %}
                {# Add separator only if BOTH list and text exist #}
                 {% if symptoms %}<hr class="section-divider">{% endif %}
                 <h4>Symptom Details:</h4>
                 <div class="content-container">
                     <div class="content-snippet symptoms-snippet">
                         {{ condition.symptoms_snippet | safe }}
                     </div>
                     <div class="content-full symptoms-full">
                          {{ condition.symptoms_text | safe }}
                     </div>
                      <button class="read-more-btn" data-target-snippet=".symptoms-snippet" data-target-full=".symptoms-full" aria-expanded="false" data-has-more="{{ 'true' if condition.symptoms_has_more else 'false' }}">Read more <span class="arrow">▼</span></button>
                 </div>
            {% endif %}
        </div>
        {% endif %} {# --- End Symptoms Section --- #}


        {# --- Causes & Risk Factors Section --- #}
        {% if condition.causes_text or risk_factors or condition.age_relevance or condition.gender_relevance %}
        <div class="card">
            <h3><i class="fas fa-question-circle"></i> Causes & Risk Factors</h3>
            {# Text Description of Causes #}
            {% if condition.causes_text %}
             <div class="content-container">
                 <div class="content-snippet causes-snippet">{{ condition.causes_snippet | safe }}</div>
                 <div class="content-full causes-full">{{ condition.causes_text | safe }}</div>
                 <button class="read-more-btn" data-target-snippet=".causes-snippet" data-target-full=".causes-full" aria-expanded="false" data-has-more="{{ 'true' if condition.causes_has_more else 'false' }}">Read more <span class="arrow">▼</span></button>
             </div>
             {% if risk_factors or condition.age_relevance or condition.gender_relevance %}<hr class="section-divider">{% endif %}
            {% endif %}

            {# Associated Risk Factors (using standard association-list styling now) #}
            {% if risk_factors %}
                <h4>Risk Factors Include:</h4>
                <ul class="association-list">
                    {% for rf in risk_factors %}
                        <li>{{ rf.factor_name | escape }} <span class="text-muted">({{ rf.factor_type | title }})</span></li>
                    {% endfor %}
                </ul>
                 {% if condition.age_relevance or condition.gender_relevance %}<div style="margin-top: 1rem;"></div>{% endif %}
            {% endif %}

             {# Relevance #}
             {% if condition.age_relevance or condition.gender_relevance %}
                <h4>Who is Affected?</h4>
                <ul class="demographic-list association-list">
                    {% if condition.age_relevance %}<li><strong>Age:</strong> {{ condition.age_relevance | escape }}</li>{% endif %}
                    {% if condition.gender_relevance %}
                        {% if condition.gender_relevance == 'all' %}<li><strong>Gender:</strong> Affects all genders.</li>
                        {% else %}<li><strong>Gender:</strong> More common in {{ condition.gender_relevance | title }}s.</li>{% endif %}
                    {% endif %}
                </ul>
             {% endif %}
        </div>
        {% endif %} {# End Causes & Risk Factors Section #}


         {# --- Diagnosis & Testing Section --- #}
         {% if condition.diagnosis or condition.testing %}
         <div class="card">
            <h3><i class="fas fa-stethoscope"></i> Diagnosis & Testing</h3>
            {% if condition.diagnosis %}
             <div class="content-container">
                <div class="content-snippet diagnosis-snippet">{{ condition.diagnosis_snippet | safe }}</div>
                <div class="content-full diagnosis-full">{{ condition.diagnosis | safe }}</div>
                <button class="read-more-btn" data-target-snippet=".diagnosis-snippet" data-target-full=".diagnosis-full" aria-expanded="false" data-has-more="{{ 'true' if condition.diagnosis_has_more else 'false' }}">Read more <span class="arrow">▼</span></button>
             </div>
             {% if condition.testing %}<hr class="section-divider">{% endif %}
            {% endif %}
            {% if condition.testing %}
                <h4>Common Tests:</h4>
                 <div class="content-container">
                    <div class="content-snippet testing-snippet">{{ condition.testing_snippet | safe }}</div>
                    <div class="content-full testing-full">{{ condition.testing | safe }}</div>
                    <button class="read-more-btn" data-target-snippet=".testing-snippet" data-target-full=".testing-full" aria-expanded="false" data-has-more="{{ 'true' if condition.testing_has_more else 'false' }}">Read more <span class="arrow">▼</span></button>
                 </div>
            {% endif %}
        </div>
         {% endif %} {# End Diagnosis & Testing Section #}

        {# --- Treatment Protocols Section --- #}
        {% if protocols %}
        <div class="card">
            <h3><i class="fas fa-pills"></i> Treatment Approaches</h3>
            {# Using standard association-list styling #}
            <ul class="association-list">
                {% for proto in protocols %}
                    <li>
                        {{ proto.protocol_name | escape }}
                        {% if proto.guideline_url %}
                            <a href="{{ proto.guideline_url }}" target="_blank" rel="noopener noreferrer" class="protocol-link" title="View Guideline"><i class="fas fa-external-link-alt fa-xs"></i></a>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        {# --- Educational Content Section --- #}
        {% if condition.educational_content %}
        <div class="card educational-content-card">
             <h3><i class="fas fa-book-open"></i> Further Information & Resources</h3>
             <div class="content-container">
                 <div class="content-snippet education-snippet">{{ condition.educational_content_snippet | safe }}</div>
                 <div class="content-full education-full">{{ condition.educational_content | safe }}</div>
                 <button class="read-more-btn" data-target-snippet=".education-snippet" data-target-full=".education-full" aria-expanded="false" data-has-more="{{ 'true' if condition.educational_content_has_more else 'false' }}">Read more <span class="arrow">▼</span></button>
             </div>
         </div>
          {% endif %}
    </div> {# End main-content #}

    {# --- Doctors Section --- #}
    <div class="doctors-section">
        <h2><i class="fas fa-user-md"></i> Find a Specialist</h2>
        {% if doctors %}
           <div class="doctors-grid">
                {% for doctor in doctors %}
                <div class="doctor-card">
                    <img src="{{ doctor.profile_picture_url | default(url_for('static', filename='images/profile_pics/default_avatar.png')) }}" alt="Dr. {{ doctor.first_name }} {{ doctor.last_name }}" class="doctor-profile-pic">
                    <div class="doctor-details">
                        <div class="doctor-name">Dr. {{ doctor.first_name }} {{ doctor.last_name }}</div>
                        <div class="doctor-specialty">{{ doctor.specialization_name | default('Specialist') }}</div>
                        {% if doctor.short_bio %}<p class="doctor-short-bio text-muted">{{ doctor.short_bio }}</p>{% endif %}
                        <a href="{{ url_for('appointment.schedule_with_doc', doctor_id=doctor.user_id) }}" class="appointment-button">Schedule Appointment</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No specific specialists listed. Please check the department or search doctors.</p>
        {% endif %}
    </div>

     {# --- Tracker Promo --- #}
     {% if condition.name == 'Migraine Headaches' or condition.name == 'Cluster Headaches' %}
     <div class="tracker-promo">
        <h3><i class="fas fa-clipboard-list"></i> Track Your {{ condition.name | escape }}</h3>
        <p>Keeping a diary can help identify triggers and improve treatment. Record details like date/time, symptoms, severity, potential triggers (food, stress, sleep), and medications taken.</p>
        <a href="#" class="tracker-button">Download Diary Template</a> {# Link to actual template #}
     </div>
     {% endif %}
</div>
{% endblock %}

{% block scripts %}
{# Keep existing read-more JS - no changes needed #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const readMoreButtons = document.querySelectorAll('.read-more-btn');
        readMoreButtons.forEach(button => {
            const container = button.closest('.content-container');
            if (!container) return;
            const snippetElement = container.querySelector(button.dataset.targetSnippet);
            const fullElement = container.querySelector(button.dataset.targetFull);
            const hasMore = button.dataset.hasMore === 'true';

            if (!snippetElement || !fullElement || !hasMore) {
                 button.style.display = 'none';
                 if (fullElement && fullElement.textContent.trim()) { fullElement.style.display = 'block'; if (snippetElement) snippetElement.style.display = 'none'; }
                 else if (snippetElement && snippetElement.textContent.trim()) { snippetElement.style.display = 'block'; }
                 return;
            }
            snippetElement.style.display = 'block'; fullElement.style.display = 'none';
            button.setAttribute('aria-expanded', 'false'); button.innerHTML = 'Read more <span class="arrow">▼</span>';
            button.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                snippetElement.style.display = isExpanded ? 'block' : 'none'; fullElement.style.display = isExpanded ? 'none' : 'block';
                this.setAttribute('aria-expanded', String(!isExpanded));
                this.innerHTML = isExpanded ? 'Read more <span class="arrow">▼</span>' : 'Read less <span class="arrow">▲</span>';
                this.classList.toggle('expanded', !isExpanded);
            });
        });
    });
 </script>
{% endblock %}