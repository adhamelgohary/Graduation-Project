{% extends "Website/base.html" %}

{% block title %}{{ condition.name | default('Condition Information') }} - Pro Health Center{% endblock %}

{% block head_extra %}
  {% if condition.specific_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename=condition.specific_css) }}">
  {% else %}
    <link rel="stylesheet" href="{{ url_for('static', filename='website/generic_disease.css') }}">
  {% endif %}
{% endblock %}

{% block content %}
<div class="disease-container">
    <div class="header">
        <h1>{{ condition.name | default('Condition Details') }}</h1>
    </div>

    <div class="top-content">
        <div class="centered-gif">
            {# Use condition.image_url generated by backend #}
            <img src="{{ condition.image_url }}" alt="{{ condition.name | escape }} illustration">
        </div>
        <div class="overview-container">
            <h2><i class="fas fa-info-circle"></i> Overview</h2>
            {% if condition.description and condition.description != condition.overview %}
            <span class="description-emphasis">{{ condition.description | safe }}</span>
            <hr>
            {% endif %}
            <div>
                {{ condition.overview | default('No overview available.') | safe }}
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="card quick-facts-card">
            <h3><i class="fas fa-list-check"></i> Quick Facts</h3>
            <dl class="quick-facts-list">
                {% if condition.condition_type %} <dt><i class="fas fa-tag fa-fw"></i>Type:</dt> <dd>{{ condition.condition_type | title }}</dd> {% endif %}
                {% if condition.urgency_level %} <dt><i class="fas fa-exclamation-circle fa-fw"></i>Urgency:</dt> <dd>{{ condition.urgency_level | title }}</dd> {% endif %}
                {% if condition.typical_duration %} <dt><i class="far fa-clock fa-fw"></i>Duration:</dt> <dd>{{ condition.typical_duration | escape }}</dd> {% endif %}
                {% if condition.icd_code %} <dt><i class="fas fa-barcode fa-fw"></i>ICD-10:</dt> <dd>{{ condition.icd_code | escape }}</dd> {% endif %}
                {% if condition.specialist_type %} <dt><i class="fas fa-user-md fa-fw"></i>Specialist:</dt> <dd>{{ condition.specialist_type | escape }}</dd> {% endif %}
                {% if condition.self_treatable_display %} <dt><i class="fas fa-notes-medical fa-fw"></i>Self-Treatable:</dt> <dd>{{ condition.self_treatable_display }}</dd> {% endif %}
            </dl>
        </div>

        {% if condition.symptoms or condition.causes or condition.age_relevance or condition.gender_relevance %}
        <div class="card">
            {% if condition.symptoms %}
            <h3><i class="fas fa-head-side-cough"></i> Symptoms</h3>
            <div class="content-container">
                <div class="content-snippet symptoms-snippet">
                    {{ condition.symptoms_snippet | safe }}
                </div>
                <div class="content-full symptoms-full">
                     {{ condition.symptoms | safe }}
                     {% if condition.emergency_info %}
                     <div class="emergency-signs">
                         <h4><i class="fas fa-exclamation-triangle"></i> Emergency Signs / When to Seek Help:</h4>
                          {{ condition.emergency_info | safe }}
                     </div>
                     {% endif %}
                </div>
                {% set has_symptoms_more = condition.symptoms_has_more or condition.emergency_info %}
                 <button class="read-more-btn" data-target-snippet=".symptoms-snippet" data-target-full=".symptoms-full" aria-expanded="false" data-has-more="{{ 'true' if has_symptoms_more else 'false' }}">
                     Read more <span class="arrow">▼</span>
                 </button>
            </div>
            {% endif %}

            {% if condition.symptoms and (condition.causes or condition.age_relevance or condition.gender_relevance) %}
                <hr class="section-divider">
            {% endif %}

            {% if condition.causes or condition.age_relevance or condition.gender_relevance %}
            <h3><i class="fas fa-question-circle"></i> Causes & Risk Factors</h3>
            <div class="content-container">
                 <div class="content-snippet causes-snippet">
                     {{ condition.causes_snippet | safe }}
                 </div>
                 <div class="content-full causes-full">
                     {% if condition.causes %}
                         {{ condition.causes | safe }}
                     {% endif %}
                     {% if condition.age_relevance or condition.gender_relevance %}
                        <h4 style="margin-top: 20px;">Who is Affected?</h4>
                        <ul class="demographic-list" style="padding-left: 20px; list-style: disc; margin-top: 10px;">
                            {% if condition.age_relevance %}<li><strong>Age:</strong> {{ condition.age_relevance | escape }}</li>{% endif %}
                            {% if condition.gender_relevance %}
                                {% if condition.gender_relevance == 'all' %}<li><strong>Gender:</strong> Affects all genders.</li>
                                {% else %}<li><strong>Gender:</strong> More common in {{ condition.gender_relevance | title }}s.</li>{% endif %}
                            {% endif %}
                        </ul>
                     {% endif %}
                 </div>
                 <button class="read-more-btn" data-target-snippet=".causes-snippet" data-target-full=".causes-full" aria-expanded="false" data-has-more="{{ 'true' if condition.causes_has_more else 'false' }}">
                    Read more <span class="arrow">▼</span>
                </button>
            </div>
            {% endif %}
        </div>
        {% endif %}

         {% if condition.diagnosis or condition.testing %}
        <div class="card">
            <h3><i class="fas fa-stethoscope"></i> Diagnosis & Testing</h3>
            <div class="content-container">
                <div class="content-snippet diagnosis-snippet">
                     {% if condition.diagnosis %}
                        {{ condition.diagnosis_snippet | safe }}
                     {% elif condition.testing %}
                        {{ condition.testing_snippet | safe }}
                     {% endif %}
                </div>
                <div class="content-full diagnosis-full">
                     {% if condition.diagnosis %}
                        {{ condition.diagnosis | safe }}
                     {% endif %}
                     {% if condition.testing %}
                        {% if condition.diagnosis %}<hr style="margin: 20px 0;">{% endif %}
                        <h4>Common Tests:</h4>
                        {{ condition.testing | safe }}
                     {% endif %}
                </div>
                {% set has_diag_more = condition.diagnosis_has_more or condition.testing_has_more %}
                 <button class="read-more-btn" data-target-snippet=".diagnosis-snippet" data-target-full=".diagnosis-full" aria-expanded="false" data-has-more="{{ 'true' if has_diag_more else 'false' }}">
                    Read more <span class="arrow">▼</span>
                </button>
            </div>
        </div>
         {% endif %}

          {% if condition.educational_content %}
         <div class="card educational-content-card">
             <h3><i class="fas fa-book-open"></i> Further Information & Resources</h3>
             <div class="content-container">
                 <div class="content-snippet education-snippet">
                     {{ condition.educational_content_snippet | safe }}
                 </div>
                 <div class="content-full education-full">
                     {{ condition.educational_content | safe }}
                 </div>
                 <button class="read-more-btn" data-target-snippet=".education-snippet" data-target-full=".education-full" aria-expanded="false" data-has-more="{{ 'true' if condition.educational_content_has_more else 'false' }}">
                     Read more <span class="arrow">▼</span>
                 </button>
             </div>
         </div>
          {% endif %}
    </div>

     <div class="doctors-section">
        <h2><i class="fas fa-user-md"></i> Find a Specialist</h2>
        {% if doctors %}
            <div class="doctors-grid">
                {% for doctor in doctors %}
                <div class="doctor-card">
                    <div class="doctor-avatar">
                        {# Use doctor.profile_picture_url generated by backend #}
                        <img src="{{ doctor.profile_picture_url | default(url_for('static', filename='images/profile_pics/default_avatar.png')) }}" alt="Dr. {{ doctor.first_name | escape }} {{ doctor.last_name | escape }}" class="doctor-profile-pic">
                    </div>
                    <div class="doctor-details">
                        <div class="doctor-name">Dr. {{ doctor.first_name | escape }} {{ doctor.last_name | escape }}</div>
                        <div class="doctor-specialty">{{ doctor.specialization | default('Specialist') }}</div>
                        {% if doctor.short_bio %}<p class="doctor-short-bio text-muted">{{ doctor.short_bio | escape }}</p>{% endif %}
                        <a href="{{ url_for('appointment.schedule_with_doc', doctor_id=doctor.user_id) | default('#') }}" class="appointment-button">Schedule Appointment</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No specific specialists are listed for this condition currently. Please check the department page or contact our general appointment line.</p>
        {% endif %}
    </div>

     {% if condition.name == 'Migraine Headaches' or condition.name == 'Cluster Headaches' %}
     <div class="tracker-promo">
        <h3><i class="fas fa-clipboard-list"></i> Track Your {{ condition.name | escape }}</h3>
        <p>Keeping a diary can help identify triggers and improve treatment. Record details like date/time, symptoms, severity, potential triggers (food, stress, sleep), and medications taken.</p>
        <a href="#" class="tracker-button">Download Diary Template</a>
     </div>
     {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const readMoreButtons = document.querySelectorAll('.read-more-btn');
        readMoreButtons.forEach(button => {
            const container = button.closest('.content-container');
            if (!container) return;
            const snippetElement = container.querySelector(button.dataset.targetSnippet);
            const fullElement = container.querySelector(button.dataset.targetFull);
            const hasMore = button.dataset.hasMore === 'true';
            if (!snippetElement || !fullElement || !hasMore) {
                 button.style.display = 'none';
                 if (snippetElement && fullElement) {
                      snippetElement.style.display = 'block';
                      fullElement.style.display = 'none';
                 } else if (fullElement) {
                     fullElement.style.display = 'block';
                     if (snippetElement) snippetElement.style.display = 'none';
                 } else if (snippetElement) {
                     snippetElement.style.display = 'block';
                 }
                 return;
            }
            snippetElement.style.display = 'block';
            fullElement.style.display = 'none';
            button.setAttribute('aria-expanded', 'false');
            button.innerHTML = 'Read more <span class="arrow">▼</span>';
            button.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';
                if (isExpanded) {
                    snippetElement.style.display = 'block';
                    fullElement.style.display = 'none';
                    this.setAttribute('aria-expanded', 'false');
                    this.innerHTML = 'Read more <span class="arrow">▼</span>';
                    this.classList.remove('expanded');
                } else {
                    snippetElement.style.display = 'none';
                    fullElement.style.display = 'block';
                    this.setAttribute('aria-expanded', 'true');
                    this.innerHTML = 'Read less <span class="arrow">▲</span>';
                    this.classList.add('expanded');
                }
            });
        });
    });
 </script>
{% endblock %}