{# --- START OF FILE templates/Website/appointment_form.html --- #}
{% extends "Website/base.html" %}

{% block title %}Schedule Appointment - Pro Health Center{% endblock %}

{% block head_extra %}
  {# Link base appointment CSS (if separated) or specific step CSS #}
  <link rel="stylesheet" href="{{ url_for('static', filename='Website/appointment.css') }}">
  {# Add CSS for date picker if you use one #}
  <style>
    /* Style for loading indicator */
    .loading-indicator {
        display: none; /* Hidden by default */
        color: var(--neon-blue);
        font-style: italic;
        margin-top: 5px;
    }
    /* Style for disabled time slots */
    #appointment_time option:disabled {
        color: #aaa;
        background-color: #eee;
    }
    [data-theme="dark"] #appointment_time option:disabled {
        color: #666;
        background-color: #222;
    }
    /* Style for doctor info card */
     .doctor-info-card {
        background-color: var(--nested-card-bg, var(--bg-secondary)); /* Use nested or secondary */
        border-radius: 12px;
        padding: 20px;
        border: 1px solid var(--border-color);
        margin-bottom: 30px;
        text-align: center;
     }
     .doctor-info-card img {
         width: 100px;
         height: 100px;
         border-radius: 50%;
         object-fit: cover;
         margin-bottom: 15px;
         border: 2px solid var(--border-color);
     }
      .doctor-info-card h3 {
          font-size: 1.2em;
          margin-bottom: 5px;
          padding-bottom: 0;
          border-bottom: none;
      }
       .doctor-info-card h3::after { display: none; } /* Remove underline from h3 */
       .doctor-info-card p {
           font-size: 0.95em;
           color: var(--text-secondary);
           margin-bottom: 0;
       }

  </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-section">
        {# Display Doctor Info #}
        <div class="doctor-info-card">
            {% if doctor.profile_photo_url %}
             <img src="{{ url_for('static', filename=doctor.profile_photo_url) }}" alt="Dr. {{ doctor.last_name }}">
            {% else %}
             <img src="{{ url_for('static', filename='images/default_doctor.png') }}" alt="Default Doctor Avatar"> {# Fallback image #}
            {% endif %}
            <h3>Dr. {{ doctor.first_name }} {{ doctor.last_name }}</h3>
            <p>{{ doctor.specialization_name | default('Specialist') }}</p>
            {# <p>{{ doctor.department_name | default('') }}</p> #}
        </div>

        <h2>Schedule Your Appointment</h2>

        {# Display flash messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}">{{ message }}</div> {# Add CSS for .alert #}
            {% endfor %}
          {% endif %}
        {% endwith %}

        {# The actual form #}
        <form method="POST" action="{{ url_for('appointment.schedule_appointment_datetime', doctor_id=doctor.user_id) }}">
            {# Hidden field might be useful if form structure changes #}
            {# <input type="hidden" name="doctor_id" value="{{ doctor.user_id }}"> #}

            {# Patient Info (if not pre-filled based on login) #}
            {# Example: Only show if admin is booking for patient #}
            {# {% if current_user.role == 'admin' %} ... {% endif %} #}
            {# Based on original HTML, assuming patient enters these - maybe prefill? #}
             <div class="form-group">
                <label for="name">Your Name</label>
                 {# Pre-fill name if possible from current_user #}
                <input type="text" id="name" name="patient_name" placeholder="Your Full Name" value="{{ current_user.first_name }} {{ current_user.last_name }}" readonly required>
            </div>
             <div class="form-group">
                <label for="phone">Your Phone Number</label>
                 {# Pre-fill phone if possible #}
                <input type="tel" id="phone" name="patient_phone" placeholder="(123) 456 - 789" value="{{ current_user.phone | default('') }}" required>
            </div>
             {# Medical Record Number might not be needed here if linked via patient_id #}
             {# <div class="form-group"> ... </div> #}


            {# Appointment Details #}
            <div class="form-row" style="display: flex; gap: 20px;">
                 {# Department - Could be hidden or pre-selected based on doctor #}
                <div class="form-group" style="flex: 1;">
                    <label for="department_display">Department</label>
                    <input type="text" id="department_display" value="{{ doctor.department_name | default('N/A') }}" readonly>
                    {# Optionally pass actual department_id if needed by backend #}
                    {# <input type="hidden" name="department_id" value="{{ doctor.department_id }}"> #}
                </div>

                <div class="form-group" style="flex: 1;">
                  <label for="appointment_type">Appointment Type</label>
                  <select id="appointment_type" name="appointment_type" required>
                    <option value="" disabled selected>Select Type...</option>
                    {% for type in appointment_types %}
                        <option value="{{ type.type_name }}" {% if type.type_name == selected_appointment_type %}selected{% endif %}>
                            {{ type.type_name }}
                        </option>
                    {% endfor %}
                  </select>
                </div>
            </div>

            <div class="form-row" style="display: flex; gap: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label for="appointment_date">Select Date</label>
                    <div class="date-field">
                         {# Use HTML5 date picker #}
                        <input type="date" id="appointment_date" name="appointment_date"
                               min="{{ today_date }}" {# Pass today_date from backend #}
                               value="{{ selected_date | default('') }}" required>
                    </div>
                </div>

                <div class="form-group" style="flex: 1;">
                    <label for="appointment_time">Select Time</label>
                     {# This select will be populated by JavaScript #}
                    <select id="appointment_time" name="appointment_time" required disabled>
                        <option value="" selected>Select a date first</option>
                    </select>
                    <div id="loading-slots" class="loading-indicator">Loading available times...</div>
                </div>
            </div>

            <div class="form-group">
                <label for="reason">Reason for Visit (Optional)</label>
                <textarea id="reason" name="reason" rows="3" placeholder="Briefly describe the reason for your visit...">{{ reason_value | default('') }}</textarea>
                 {# Add textarea styling in CSS if needed #}
            </div>


            <div class="button-row">
                {# Back button could go to doctor list or previous step #}
                <button type="button" class="btn-submit back" onclick="window.history.back();">
                  Back
                   <svg width="16" height="16" ... >...</svg>
                </button>
                <button type="submit" class="btn-submit">
                  Schedule Appointment
                   <svg width="16" height="16" ... >...</svg>
                </button>
            </div>
        </form>
    </div> {# End form-section #}

    {# Remove or replace the generic contact section with doctor-specific info if desired #}
    <div class="contact-section">
      <h2>Doctor Information</h2> {# Changed title #}
      <div class="contact-card">
         {# Use specific doctor image if available #}
         {% if doctor.profile_photo_url %}
             <img src="{{ url_for('static', filename=doctor.profile_photo_url) }}" alt="Dr. {{ doctor.last_name }}" class="doctor-image">
         {% else %}
             <img src="{{ url_for('static', filename='images/default_doctor.png') }}" alt="Doctor Avatar" class="doctor-image">
         {% endif %}
        <div class="contact-info">
          <h3>{{ doctor.first_name }} {{ doctor.last_name }}</h3>
           <p>{{ doctor.specialization_name | default('Specialist') }}</p>
           {# Add other relevant doctor info if available #}
           {% if doctor.clinic_address %}
           <h3>Clinic Address</h3>
           <p class="contact-value">{{ doctor.clinic_address }}</p>
           {% endif %}
           {# Add phone etc if available in 'doctor' object #}
           {# <h3>Phone</h3> ... #}
        </div>
      </div>
    </div>

</div> {# End container #}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('appointment_date');
    const timeSelect = document.getElementById('appointment_time');
    const loadingIndicator = document.getElementById('loading-slots');
    const doctorId = "{{ doctor.user_id | tojson }}"; // Pass doctor ID securely

    if (dateInput && timeSelect && loadingIndicator && doctorId) {
        dateInput.addEventListener('change', function() {
            const selectedDate = this.value; // Format: YYYY-MM-DD

            // Clear previous options and show loading
            timeSelect.innerHTML = '<option value="" selected>Loading...</option>';
            timeSelect.disabled = true;
            loadingIndicator.style.display = 'block';

            if (selectedDate) {
                // Fetch available slots using AJAX
                const availabilityUrl = `/appointments/availability/${doctorId}/${selectedDate}`; // Use url_for in production if possible

                fetch(availabilityUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        timeSelect.innerHTML = ''; // Clear loading/previous options
                        if (data.available_slots && data.available_slots.length > 0) {
                            timeSelect.disabled = false;
                            timeSelect.innerHTML = '<option value="" disabled selected>Select a time...</option>'; // Add placeholder
                            data.available_slots.forEach(slot => {
                                // Optional: Format time for display (e.g., 14:30 to 2:30 PM)
                                const timeParts = slot.split(':');
                                const hour = parseInt(timeParts[0], 10);
                                const minute = timeParts[1];
                                const ampm = hour >= 12 ? 'PM' : 'AM';
                                const displayHour = hour % 12 === 0 ? 12 : hour % 12;
                                const displayTime = `${displayHour}:${minute} ${ampm}`;

                                const option = document.createElement('option');
                                option.value = slot; // Keep value as HH:MM for backend
                                option.textContent = displayTime;
                                timeSelect.appendChild(option);
                            });
                        } else {
                            timeSelect.innerHTML = '<option value="" disabled selected>No slots available</option>';
                            timeSelect.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching availability:', error);
                        timeSelect.innerHTML = '<option value="" disabled selected>Error loading times</option>';
                        timeSelect.disabled = true;
                        // Optionally display a user-friendly error message
                        flash('Could not load available times. Please try again later.', 'danger'); // Need flash message setup
                    })
                    .finally(() => {
                        loadingIndicator.style.display = 'none'; // Hide loading
                    });
            } else {
                // No date selected
                timeSelect.innerHTML = '<option value="" selected>Select a date first</option>';
                timeSelect.disabled = true;
                loadingIndicator.style.display = 'none';
            }
        });

        // Trigger change event if a date is pre-selected (e.g., on form validation error reload)
        if(dateInput.value) {
            dateInput.dispatchEvent(new Event('change'));
        }
    }

    // Theme toggle is handled by base.html
});
</script>
{% endblock %}