{% extends "Website/base.html" %}

{% block title %}Schedule Appointment{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{{ url_for('static', filename='Website/appointments.css') }}">
    <style>
        /* Add specific styles from appointments.css if needed or keep them there */
    </style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="page-header">
        <h1>Schedule Appointment</h1>
         <a href="{{ url_for('doctor.list_doctors') }}" class="button button-outline button-secondary button-small">
             <i class="fas fa-arrow-left fa-fw"></i> Back to Doctors
         </a>
    </div>

    {% include '_flash_messages.html' %}

    <div class="card content-section appointment-form-card">
        <div class="card-body">
            {% if doctor %}
            {# --- Doctor Info Display --- #}
            <div class="doctor-info-card">
                <img src="{{ url_for('static', filename=doctor.profile_photo_url or 'images/default_doctor.png') }}" alt="Dr. {{ doctor.last_name }}">
                <div>
                    <h4>Dr. {{ doctor.first_name }} {{ doctor.last_name }}</h4>
                    <p>{{ doctor.specialization_name | default('Doctor') }}</p>
                     {% if doctor.department_name %} <p>{{ doctor.department_name }}</p> {% endif %}
                </div>
            </div>

            {# --- Scheduling Form --- #}
            <form id="schedule-form" action="{{ url_for('appointment.schedule_appointment_datetime', doctor_id=doctor.user_id) }}" method="POST">
                <input type="hidden" name="doctor_id" value="{{ doctor.user_id }}">

                {# Step 2: Date, Time, Type, Reason, Location #}
                 <div class="row">
                    <div class="col-md-6 form-group mb-3">
                        <label for="appointment_date" class="form-label">Select Date *</label>
                        <input type="date" id="appointment_date" name="appointment_date" class="form-control"
                               value="{{ selected_date | default('') }}" required min="{{ today_date }}">
                    </div>

                    <div class="col-md-6 form-group mb-3">
                         <label for="appointment_time_select" class="form-label">Select Available Time *
                             <span id="appointment_time_display"></span> {# Display selected time #}
                         </label>
                         <div id="time-slots-container" class="time-slots border p-2">
                             <p class="text-muted initial-prompt">Please select a date first.</p>
                         </div>
                         <input type="hidden" id="appointment_time" name="appointment_time" required
                                value="{{ selected_time | default('') }}"> {# Pre-fill if coming back from error #}
                    </div>
                 </div>

                 {# --- NEW Location Dropdown --- #}
                 <div class="form-group mb-3">
                     <label for="location_id" class="form-label">Select Location *</label>
                     <select id="location_id" name="location_id" class="form-select" required>
                         <option value="" selected disabled>-- Choose Clinic Location --</option>
                          {% set current_location = selected_location_id | default('') | string %}
                         {% for loc in locations %}
                            <option value="{{ loc.location_id }}" {% if current_location == loc.location_id|string %}selected{% endif %}>
                                {{ loc.name }} {% if loc.address %} ({{ loc.address | truncate(40) }}) {% endif %}
                            </option>
                         {% endfor %}
                         {% if not locations %}
                            <option value="" disabled>No locations available.</option>
                         {% endif %}
                     </select>
                 </div>
                 {# --- End Location Dropdown --- #}

                 <div class="row">
                      <div class="col-md-6 form-group mb-3">
                         <label for="appointment_type" class="form-label">Appointment Type *</label>
                         <select id="appointment_type" name="appointment_type" class="form-select" required>
                             <option value="" disabled {% if not selected_appointment_type %}selected{% endif %}>-- Select Type --</option>
                              {% set current_type = selected_appointment_type | default('') %}
                             {% for type in appointment_types %}
                                 <option value="{{ type.type_name }}" {% if type.type_name == current_type %}selected{% endif %}>
                                     {{ type.type_name }}
                                 </option>
                             {% endfor %}
                         </select>
                     </div>
                      <div class="col-md-6 form-group mb-3">
                         <label for="patient_phone" class="form-label">Confirm/Update Phone Number *</label>
                         <input type="tel" id="patient_phone" name="patient_phone" class="form-control"
                                value="{{ phone_value | default(current_user.phone | default('')) }}" required placeholder="e.g., 123-456-7890">
                     </div>
                 </div>

                 <div class="form-group mb-3">
                    <label for="reason" class="form-label">Reason for Visit (Briefly)</label>
                    <textarea id="reason" name="reason" class="form-control" rows="3" placeholder="Optional: Briefly state the reason for your visit...">{{ reason_value | default('') }}</textarea>
                 </div>


                <div class="form-actions mt-4 pt-3 border-top">
                    <button type="submit" class="button button-primary" id="submit-button" disabled>
                        <i class="fas fa-check-circle fa-fw"></i> Confirm Appointment
                    </button>
                </div>
            </form>
            {% else %}
                 <p>Doctor information could not be loaded.</p>
            {% endif %}
        </div> {# end card-body #}
    </div> {# end card #}
</div> {# end main-container #}
{% endblock %}

{% block scripts %}
{# Keep existing JavaScript for fetching time slots - no changes needed there #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('appointment_date');
    const timeSlotsContainer = document.getElementById('time-slots-container');
    const hiddenTimeInput = document.getElementById('appointment_time');
    const submitButton = document.getElementById('submit-button');
    const selectedTimeDisplay = document.getElementById('appointment_time_display');
    const doctorId = '{{ doctor.user_id if doctor else "" }}';

    function clearTimeSlots() { /* ... as before ... */
        timeSlotsContainer.innerHTML = '<p class="text-muted initial-prompt">Please select a date.</p>';
        hiddenTimeInput.value = '';
        selectedTimeDisplay.textContent = '';
        submitButton.disabled = true;
    }

    async function fetchAndDisplaySlots(selectedDate) { /* ... as before ... */
        if (!selectedDate || !doctorId) { clearTimeSlots(); return; }
        timeSlotsContainer.innerHTML = '<div class="loading-slots">Loading... <i class="fas fa-spinner fa-spin"></i></div>';
        hiddenTimeInput.value = ''; selectedTimeDisplay.textContent = ''; submitButton.disabled = true;
        try {
            const url = `/appointments/availability/${doctorId}/${selectedDate}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            timeSlotsContainer.innerHTML = '';
            if (data.error) { timeSlotsContainer.innerHTML = `<p class="text-danger">${data.error}</p>`; }
            else if (data.available_slots && data.available_slots.length > 0) {
                data.available_slots.forEach(slot => {
                    const slotElement = document.createElement('div');
                    slotElement.classList.add('time-slot');
                    slotElement.textContent = formatTime(slot);
                    slotElement.dataset.timeValue = slot;
                    // Pre-select if matches hidden input value (for errors)
                    if (hiddenTimeInput.value === slot) {
                         slotElement.classList.add('selected');
                         selectedTimeDisplay.textContent = `(${formatTime(slot)})`;
                         submitButton.disabled = false;
                    }
                    slotElement.addEventListener('click', handleSlotSelection);
                    timeSlotsContainer.appendChild(slotElement);
                });
            } else { timeSlotsContainer.innerHTML = '<p class="text-muted">No available slots for this date.</p>'; }
        } catch (error) { console.error('Error fetching availability:', error); timeSlotsContainer.innerHTML = '<p class="text-danger">Could not load times.</p>'; }
    }

    function handleSlotSelection(event) { /* ... as before ... */
        timeSlotsContainer.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
        const selectedSlot = event.target;
        selectedSlot.classList.add('selected');
        hiddenTimeInput.value = selectedSlot.dataset.timeValue;
        selectedTimeDisplay.textContent = `(${selectedSlot.textContent})`;
        submitButton.disabled = false;
    }

    function formatTime(timeString24) { /* ... as before ... */
       try { const [hours, minutes] = timeString24.split(':').map(Number); const date = new Date(); date.setHours(hours, minutes, 0, 0); const ampm = hours >= 12 ? 'PM' : 'AM'; const hours12 = hours % 12 || 12; return `${hours12}:${minutes.toString().padStart(2, '0')} ${ampm}`; } catch (e) { return timeString24; }
    }

    if (dateInput) {
        dateInput.addEventListener('change', function() { fetchAndDisplaySlots(this.value); });
        if (dateInput.value) { fetchAndDisplaySlots(dateInput.value); } // Fetch on load if date pre-filled
    }
});
</script>
{% endblock %}